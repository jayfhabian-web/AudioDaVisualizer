<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Phonk V24 - The Sculptor</title>
    <style>
        /* --- THEME --- */
        :root {
            --bg: #000;
            --panel: rgba(10, 10, 10, 0.96);
            --border: rgba(255, 255, 255, 0.15);
            --text: #ccc;
        }
        * { box-sizing: border-box; user-select: none; }

        body { margin: 0; background: var(--bg); font-family: 'Segoe UI', monospace; overflow: hidden; color: var(--text); }
        
        #flash-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; opacity: 0; mix-blend-mode: screen; }
        #canvas-layer { position: absolute; top: 0; left: 0; z-index: 1; }
        
        #logo-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 320px; height: 320px; z-index: 5; border-radius: 50%; 
            background-size: cover; background-position: center;
            box-shadow: 0 0 100px rgba(0,0,0,1);
            border: 2px solid rgba(255,255,255,0.05);
        }

        /* UI PANEL */
        #ui-panel {
            position: absolute; top: 0; left: 0; width: 380px; height: 100vh;
            background: var(--panel); border-right: 1px solid var(--border);
            padding: 15px; z-index: 20; overflow-y: auto;
            transition: transform 0.2s ease;
        }
        #ui-panel.hidden { transform: translateX(-100%); }

        h2 { font-size: 14px; color: #fff; margin: 0 0 15px 0; border-left: 3px solid #fff; padding-left: 10px; text-transform: uppercase; letter-spacing: 2px; }
        h3 { font-size: 10px; color: #666; margin-top: 20px; border-bottom: 1px solid #333; padding-bottom: 4px; font-weight: 700; text-transform: uppercase; }

        .control-group { margin-bottom: 12px; }
        label { display: flex; justify-content: space-between; font-size: 9px; color: #888; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; }

        input[type="range"] { width: 100%; height: 4px; background: #222; border-radius: 2px; appearance: none; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 10px; height: 10px; background: #fff; border-radius: 50%; }
        input[type="file"] { width: 100%; background: #111; border: 1px solid #222; color: #666; padding: 6px; border-radius: 4px; font-size: 9px; }
        
        /* --- THE SCULPTOR GRID --- */
        .sculptor-grid {
            display: flex; gap: 5px; height: 180px; background: #050505; 
            border: 1px solid #333; padding: 5px; margin-bottom: 10px;
        }
        .sculpt-col { 
            flex: 1; display: flex; flex-direction: column; 
            border: 1px solid #222; background: #111; position: relative;
        }
        
        /* The Graph Area inside the column */
        .graph-area {
            flex: 1; position: relative; width: 100%; overflow: hidden; cursor: row-resize;
            background: rgba(0,0,0,0.5);
        }
        .audio-bar { 
            position: absolute; bottom: 0; left: 0; width: 100%; 
            height: 0%; background: #444; opacity: 0.6; transition: height 0.05s, background-color 0.1s; 
        }
        .audio-bar.active { opacity: 1; box-shadow: 0 0 15px currentColor; }
        
        /* The Draggable Line */
        .thresh-line {
            position: absolute; left: 0; width: 100%; height: 2px; 
            background: #fff; z-index: 10; box-shadow: 0 1px 2px black;
            pointer-events: none; /* Let clicks pass through to container for easier dragging */
        }

        /* Controls under each bar */
        .col-controls {
            height: 60px; padding: 4px; display: flex; flex-direction: column; gap: 4px;
            border-top: 1px solid #222; background: #080808;
        }
        input[type="color"] { width: 100%; height: 15px; border: none; padding: 0; background: none; cursor: pointer; }
        .punch-slider { width: 100%; }

        .freq-label { font-size: 8px; text-align: center; color: #555; margin-top: 2px; font-weight: bold;}

        /* Visual Settings */
        .checkbox-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; background: #0f0f0f; padding: 8px; border-radius: 4px; border: 1px solid #222; }
        
        #toggle-ui { position: absolute; top: 15px; left: 400px; z-index: 25; background: #000; color: #fff; border: 1px solid #333; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-size: 9px; font-weight: bold; letter-spacing: 1px; }
        #ui-panel.hidden + #toggle-ui { left: 15px; }
    </style>
</head>
<body>

    <div id="flash-layer"></div>
    <canvas id="canvas-layer"></canvas>
    <div id="logo-container"></div>
    <button id="toggle-ui" onclick="toggleUI()">OPEN SCULPTOR</button>

    <div id="ui-panel" id="panel">
        <h2>Phonk V24 <span style="font-size:9px; opacity:0.5">SCULPTOR</span></h2>

        <div class="control-group">
            <label>Track</label>
            <input type="file" id="file-in" accept="audio/*">
            <audio id="audio" controls style="width:100%; margin-top:5px; height:20px; opacity:0.6;"></audio>
        </div>
        <div class="control-group">
            <label>Image</label>
            <input type="file" id="img-in" accept="image/*">
        </div>

        <h3>1. Frequency Sculptor</h3>
        <p style="font-size:9px; color:#555; margin-bottom:10px;">
            • Drag the <b>White Lines</b> to set trigger threshold.<br>
            • Use <b>Punch Slider</b> to boost specific bass.<br>
            • Pick <b>Colors</b> for each frequency range.
        </p>

        <div class="checkbox-row">
            <input type="checkbox" id="freq-mode" checked>
            <span style="font-size:10px; color:white;"><b>FREQUENCY COLOR MODE</b> (Circle changes color)</span>
        </div>

        <div class="sculptor-grid">
            <div class="sculpt-col">
                <div class="graph-area" id="graph-0" onmousedown="startDrag(0, event)">
                    <div class="audio-bar" id="bar-0"></div>
                    <div class="thresh-line" id="line-0" style="bottom: 80%;"></div>
                </div>
                <div class="col-controls">
                    <div class="freq-label">20Hz</div>
                    <input type="color" id="col-0" value="#444444" title="Color">
                    <input type="range" class="punch-slider" id="punch-0" min="0" max="3" step="0.1" value="1.0" title="Punch Volume">
                </div>
            </div>

            <div class="sculpt-col">
                <div class="graph-area" id="graph-1" onmousedown="startDrag(1, event)">
                    <div class="audio-bar" id="bar-1"></div>
                    <div class="thresh-line" id="line-1" style="bottom: 60%;"></div>
                </div>
                <div class="col-controls">
                    <div class="freq-label">40Hz</div>
                    <input type="color" id="col-1" value="#ff0000" title="Color">
                    <input type="range" class="punch-slider" id="punch-1" min="0" max="3" step="0.1" value="1.5" title="Punch Volume">
                </div>
            </div>

            <div class="sculpt-col">
                <div class="graph-area" id="graph-2" onmousedown="startDrag(2, event)">
                    <div class="audio-bar" id="bar-2"></div>
                    <div class="thresh-line" id="line-2" style="bottom: 65%;"></div>
                </div>
                <div class="col-controls">
                    <div class="freq-label">60Hz</div>
                    <input type="color" id="col-2" value="#ff8800" title="Color">
                    <input type="range" class="punch-slider" id="punch-2" min="0" max="3" step="0.1" value="1.2" title="Punch Volume">
                </div>
            </div>

            <div class="sculpt-col">
                <div class="graph-area" id="graph-3" onmousedown="startDrag(3, event)">
                    <div class="audio-bar" id="bar-3"></div>
                    <div class="thresh-line" id="line-3" style="bottom: 85%;"></div>
                </div>
                <div class="col-controls">
                    <div class="freq-label">80Hz</div>
                    <input type="color" id="col-3" value="#ffffff" title="Color">
                    <input type="range" class="punch-slider" id="punch-3" min="0" max="3" step="0.1" value="0.8" title="Punch Volume">
                </div>
            </div>
        </div>

        <h3>2. Global Visuals</h3>
        <div class="control-group">
            <label>Master Bar Length</label>
            <input type="range" id="bar-len" min="50" max="400" value="160">
        </div>
        <div class="control-group">
            <label>Circle Radius</label>
            <input type="range" id="radius" min="100" max="350" value="170">
        </div>
        <div class="control-group">
            <label>Bar Width</label>
            <input type="range" id="bar-width" min="2" max="50" value="25">
        </div>

        <div class="checkbox-row" style="flex-wrap:wrap; margin-top:10px;">
            <label style="margin-right:10px;"><input type="checkbox" id="fx-zoom" checked> Zoom</label>
            <label style="margin-right:10px;"><input type="checkbox" id="fx-shake" checked> Shake</label>
            <label><input type="checkbox" id="fx-flash" checked> Flash</label>
        </div>
    </div>

    <script>
        // --- DOM REFERENCES ---
        const dom = {
            audio: document.getElementById('audio'),
            canvas: document.getElementById('canvas-layer'),
            ctx: document.getElementById('canvas-layer').getContext('2d'),
            logo: document.getElementById('logo-container'),
            flash: document.getElementById('flash-layer'),
            panel: document.getElementById('ui-panel'),
            // Arrays for the 4 bands
            bars: [0,1,2,3].map(i => document.getElementById(`bar-${i}`)),
            lines: [0,1,2,3].map(i => document.getElementById(`line-${i}`)),
            colors: [0,1,2,3].map(i => document.getElementById(`col-${i}`)),
            punches: [0,1,2,3].map(i => document.getElementById(`punch-${i}`)),
            freqMode: document.getElementById('freq-mode')
        };
        
        dom.canvas.width = window.innerWidth;
        dom.canvas.height = window.innerHeight;

        // --- STATE ---
        const state = {
            connected: false,
            physics: 0,
            thresholds: [0.8, 0.6, 0.65, 0.85], // 0.0 to 1.0 (normalized)
            activeColor: '#ffffff' // The color currently winning
        };

        // --- DRAG LOGIC ---
        let dragTarget = -1;
        
        function startDrag(index, e) {
            dragTarget = index;
            updateDrag(e);
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', endDrag);
        }
        function onDrag(e) { if(dragTarget !== -1) updateDrag(e); }
        function endDrag() { 
            dragTarget = -1; 
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', endDrag);
        }
        function updateDrag(e) {
            const rect = document.getElementById(`graph-${dragTarget}`).getBoundingClientRect();
            // Calculate percentage from bottom (inverted Y)
            let y = 1.0 - ((e.clientY - rect.top) / rect.height);
            // Clamp
            if (y < 0) y = 0; if (y > 1) y = 1;
            
            state.thresholds[dragTarget] = y;
            dom.lines[dragTarget].style.bottom = (y * 100) + "%";
        }

        // --- AUDIO SETUP ---
        let audioCtx, source, analyser;
        dom.audio.addEventListener('play', () => {
            if(state.connected) { if(audioCtx.state === 'suspended') audioCtx.resume(); return; }
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            source = audioCtx.createMediaElementSource(dom.audio);
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048; 
            source.connect(analyser);
            source.connect(audioCtx.destination); 
            state.connected = true;
            loop();
        });

        // --- MAIN LOOP ---
        function loop() {
            requestAnimationFrame(loop);
            const buffer = analyser.frequencyBinCount; 
            const data = new Uint8Array(buffer);
            analyser.getByteFrequencyData(data);

            // Bins 1-4 correspond to our 4 sculptor bands
            const bands = [data[1], data[2], data[3], data[4]];
            
            let totalForce = 0;
            let maxForceInLoop = 0;
            let winningIndex = -1;

            bands.forEach((val, i) => {
                // 1. Get Settings
                const normVal = val / 255;
                const punch = parseFloat(dom.punches[i].value);
                const thresh = state.thresholds[i];
                const color = dom.colors[i].value;

                // 2. Update UI Bar Height
                // Visually show the "boosted" value so user sees what Punch does
                let visualHeight = normVal * punch; 
                if(visualHeight > 1) visualHeight = 1;
                dom.bars[i].style.height = (visualHeight * 100) + "%";
                dom.bars[i].style.backgroundColor = color;

                // 3. Logic: Did it cross the line?
                if (normVal * punch > thresh) {
                    // Calculate excess force
                    let excess = (normVal * punch) - thresh;
                    totalForce += excess;

                    dom.bars[i].classList.add('active');
                    
                    // Determine dominant color
                    if (excess > maxForceInLoop) {
                        maxForceInLoop = excess;
                        winningIndex = i;
                    }
                } else {
                    dom.bars[i].classList.remove('active');
                }
            });

            // 4. Update Global State
            if (winningIndex !== -1) {
                state.activeColor = dom.colors[winningIndex].value;
            }

            // Physics Smoothing
            if (totalForce > state.physics) state.physics = totalForce;
            else state.physics *= 0.85; // Decay
            
            // Safety Clamp
            if(state.physics > 2.5) state.physics = 2.5;

            draw(data, buffer, state.physics);
            applyFx(state.physics);
        }

        // --- DRAWING ---
        function draw(data, count, phys) {
            const ctx = dom.ctx;
            const cx = dom.canvas.width / 2;
            const cy = dom.canvas.height / 2;
            const baseRad = parseInt(document.getElementById('radius').value);
            const maxLen = parseInt(document.getElementById('bar-len').value);
            
            const rad = baseRad + (phys * 20); // Bounce
            const w = parseFloat(document.getElementById('bar-width').value);
            
            ctx.clearRect(0, 0, dom.canvas.width, dom.canvas.height);

            // Determine Main Color
            let mainColor = '#ffffff';
            if (dom.freqMode.checked && phys > 0.1) {
                // If Frequency Mode is ON, use the color of the band that triggered the bass
                mainColor = state.activeColor;
            } else if (!dom.freqMode.checked) {
                // Default to first band color or white
                mainColor = dom.colors[1].value; 
            }

            const cMain = hexToRgb(mainColor);
            const cWhite = {r:255, g:255, b:255};

            const totalBars = 64;
            const angleStep = Math.PI / totalBars; 

            for(let i = 0; i < totalBars; i++) {
                let index = 1 + (i * 2);
                let val = data[index];
                
                let h = (val / 255) * maxLen;
                if(h < 5) h = 5;

                // Gradient Logic
                let mix = i / 30; if(mix>1) mix=1;
                
                // If FreqMode is on, the whole circle takes the winning color, fading to white at tips
                const r = cMain.r + (cWhite.r - cMain.r) * mix;
                const g = cMain.g + (cWhite.g - cMain.g) * mix;
                const b = cMain.b + (cWhite.b - cMain.b) * mix;
                ctx.fillStyle = `rgb(${r},${g},${b})`;

                // Symmetrical Draw
                ctx.save();
                ctx.translate(cx, cy);
                ctx.rotate( (i * angleStep) - (Math.PI/2) ); 
                ctx.fillRect(rad, -w/2, h, w); 
                ctx.restore();

                ctx.save();
                ctx.translate(cx, cy);
                ctx.rotate( -(i * angleStep) - (Math.PI/2) ); 
                ctx.fillRect(rad, -w/2, h, w);
                ctx.restore();
            }
        }

        function applyFx(p) {
            let s=1, x=0, y=0, f=0;
            if (p > 0.01) {
                if(document.getElementById('fx-zoom').checked) s += (p * 0.15); 
                if(document.getElementById('fx-shake').checked) {
                    const shake = p * 15; 
                    x = (Math.random()-0.5) * shake;
                    y = (Math.random()-0.5) * shake;
                }
                if(document.getElementById('fx-flash').checked) f = p * 0.4;
            }
            dom.logo.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px)) scale(${s})`;
            dom.flash.style.opacity = f;
            dom.flash.style.background = 'white';
        }

        function hexToRgb(hex) {
            const bigint = parseInt(hex.replace('#',''), 16);
            return { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255 };
        }
        window.toggleUI = () => dom.panel.classList.toggle('hidden');
        document.getElementById('img-in').addEventListener('change', e => {
            const u = URL.createObjectURL(e.target.files[0]);
            dom.logo.style.backgroundImage = `url(${u})`;
        });
        document.getElementById('file-in').addEventListener('change', e => { dom.audio.src = URL.createObjectURL(e.target.files[0]); dom.audio.play(); });
        window.onresize = () => { dom.canvas.width=window.innerWidth; dom.canvas.height=window.innerHeight; }
    </script>
</body>
</html>
