<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Phonk V30 - VFX Rack</title>
    <style>
        /* --- THEME --- */
        :root {
            --bg: #000;
            --panel: rgba(10, 10, 10, 0.98);
            --border: rgba(255, 255, 255, 0.15);
            --text: #ccc;
            --accent: #ff0033;
            --react-active: #00ff88;
        }
        * { box-sizing: border-box; user-select: none; }

        body { margin: 0; background: var(--bg); font-family: 'Segoe UI', monospace; overflow: hidden; color: var(--text); }
        
        /* LAYERS */
        #flash-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; opacity: 0; mix-blend-mode: exclusion; background:white; }
        #vhs-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 8; opacity: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAABZJREFUeNpi2r9//38gYGAEESAAEGAAasgJOgzOKCoAAAAASUVORK5CYII='); background-size: 4px 4px; }
        #canvas-layer { position: absolute; top: 0; left: 0; z-index: 1; }
        
        #logo-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 320px; height: 320px; z-index: 5; border-radius: 50%; 
            background-size: cover; background-position: center;
            box-shadow: 0 0 100px rgba(0,0,0,1);
            border: 2px solid rgba(255,255,255,0.05);
            transition: border-color 0.1s;
        }

        /* UI PANEL */
        #ui-panel {
            position: absolute; top: 0; left: 0; width: 440px; height: 100vh;
            background: var(--panel); border-right: 1px solid var(--border);
            padding: 15px; z-index: 20; overflow-y: auto;
            transition: transform 0.2s ease;
        }
        #ui-panel.hidden { transform: translateX(-100%); }

        /* MODALS */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100; display: none;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .overlay.active { display: flex; }
        
        /* TWEAK MODAL */
        #tweak-modal { z-index: 200; background: rgba(10,10,10,0.98); backdrop-filter: blur(10px); }
        .tweak-container { width: 90%; max-width: 550px; border: 1px solid #333; padding: 20px; background: #000; border-radius: 8px; position: relative; }
        .close-btn { position: absolute; top: 10px; right: 10px; color: #555; cursor: pointer; font-size: 20px; font-weight: bold; }
        
        #tweak-graph { width: 100%; height: 150px; background: #080808; border: 1px solid #333; position: relative; margin-bottom: 20px; overflow: hidden; cursor: row-resize; }
        #tweak-bar { width: 100%; height: 0%; background: var(--accent); position: absolute; bottom: 0; left: 0; transition: height 0.05s; }
        #tweak-thresh { width: 100%; height: 2px; background: #fff; position: absolute; bottom: 80%; left: 0; box-shadow: 0 0 10px #fff; pointer-events: none; }
        
        .complex-row { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .knob-group { flex: 1; text-align: center; background: #111; padding: 5px; border: 1px solid #222; border-radius: 4px; }
        .knob-label { font-size: 8px; color: #888; text-transform: uppercase; margin-bottom: 2px; }
        .knob-val { font-size: 10px; color: var(--accent); font-weight: bold; }

        .react-btn { width: 100%; padding: 10px; background: #111; border: 1px solid #333; color: #555; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 10px; margin-bottom: 5px; }
        .react-btn.active { background: var(--react-active); color: #000; border: none; }

        /* STANDARD UI */
        h2 { font-size: 14px; color: #fff; margin: 0 0 15px 0; border-left: 3px solid var(--accent); padding-left: 10px; text-transform: uppercase; letter-spacing: 2px; }
        h3 { font-size: 10px; color: #666; margin-top: 20px; border-bottom: 1px solid #333; padding-bottom: 4px; font-weight: 700; text-transform: uppercase; }

        .control-group { margin-bottom: 12px; }
        label { display: flex; justify-content: space-between; font-size: 9px; color: #888; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; }
        input[type="range"] { width: 100%; height: 4px; background: #222; border-radius: 2px; appearance: none; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 10px; height: 10px; background: #fff; border-radius: 50%; }
        input[type="file"] { width: 100%; background: #111; border: 1px solid #222; color: #666; padding: 6px; border-radius: 4px; font-size: 9px; }
        select { width: 100%; background: #111; border: 1px solid #222; color: #ccc; padding: 6px; font-size: 10px; text-transform: uppercase; }

        /* VFX RACK STYLES */
        .vfx-row { display: flex; align-items: center; background: #0a0a0a; border: 1px solid #222; padding: 8px; margin-bottom: 5px; border-radius: 4px; }
        .vfx-name { width: 80px; font-size: 10px; font-weight: bold; color: #ccc; }
        .vfx-controls { flex: 1; display: flex; gap: 5px; align-items: center; }
        .vfx-slider { flex: 1; }
        .link-btn { width: 40px; font-size: 8px; background: #111; color: #444; border: 1px solid #333; cursor: pointer; height: 20px; text-transform: uppercase; }
        .link-btn.linked { background: var(--react-active); color: #000; border-color: var(--react-active); font-weight: bold; }

        /* MAIN DASHBOARD GRID */
        .sculptor-grid { display: flex; gap: 6px; height: 200px; background: #050505; border: 1px solid #333; padding: 6px; margin-bottom: 10px; }
        .sculpt-col { flex: 1; display: flex; flex-direction: column; border: 1px solid #222; background: #111; position: relative; }
        .graph-area { flex: 1; position: relative; width: 100%; overflow: hidden; background: rgba(0,0,0,0.5); border-bottom: 1px solid #333; cursor: row-resize; }
        .audio-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: #444; opacity: 0.7; transition: height 0.05s; }
        .thresh-line { position: absolute; left: 0; width: 100%; height: 2px; background: #fff; pointer-events: none; opacity: 1.0; z-index: 5;}

        .col-controls { height: 90px; padding: 5px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; background: #080808; }
        .tweak-trigger-btn { width:100%; background: none; border: 1px solid #333; color: #666; font-size: 10px; padding: 2px 0; cursor: pointer; border-radius: 2px; text-transform: uppercase; }
        .tweak-trigger-btn:hover { color: #fff; border-color: #fff; background: #222; }
        .gain-wrapper { position: relative; width: 100%; flex: 1; display: flex; justify-content: center; align-items: center; margin: 5px 0; background: #0e0e0e; border: 1px solid #181818; }
        input[type=range].v-slider { -webkit-appearance: none; width: 50px; height: 4px; transform: rotate(-90deg); background: #333; cursor: pointer; }
        
        .react-indicator { width: 6px; height: 6px; background: var(--react-active); border-radius: 50%; box-shadow: 0 0 5px var(--react-active); display: none; margin-bottom: 2px; }
        .react-indicator.active { display: block; }
        .checkbox-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; background: #0f0f0f; padding: 8px; border-radius: 4px; border: 1px solid #222; }
        #toggle-ui { position: absolute; top: 15px; left: 460px; z-index: 25; background: #000; color: #fff; border: 1px solid #333; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-size: 9px; font-weight: bold; letter-spacing: 1px; }
        #ui-panel.hidden + #toggle-ui { left: 15px; }
    </style>
</head>
<body>

    <div id="loader" class="overlay">
        <div style="font-size: 20px; color: var(--accent); font-weight: bold;">ANALYZING TRACK</div>
    </div>

    <div id="tweak-modal" class="overlay">
        <div class="tweak-container">
            <div class="close-btn" onclick="closeTweak()">Ã—</div>
            <h2 style="border:none; text-align:center; margin-bottom:5px;">Architect <span id="tweak-band-id" style="color:var(--accent)"></span></h2>
            
            <div id="tweak-graph" onmousedown="startDrag(state.currentTweakIndex, event, 'tweak')">
                <div id="tweak-bar"></div>
                <div id="tweak-thresh"></div>
            </div>

            <div class="complex-row">
                <div class="knob-group"><div class="knob-label">Attack</div><div class="knob-val" id="val-attack">0.0</div><input type="range" id="input-attack" min="0" max="0.9" step="0.05" oninput="updateKnobs()"></div>
                <div class="knob-group"><div class="knob-label">Decay</div><div class="knob-val" id="val-decay">0.15</div><input type="range" id="input-decay" min="0.01" max="0.5" step="0.01" oninput="updateKnobs()"></div>
                <div class="knob-group"><div class="knob-label">Gate</div><div class="knob-val" id="val-gate">0.0</div><input type="range" id="input-gate" min="0" max="0.4" step="0.01" oninput="updateKnobs()"></div>
            </div>

            <button class="react-btn" id="tweak-react-btn" onclick="toggleReact()">LINK MASTER PHYSICS</button>
            <div style="text-align:center; font-size:9px; color:#555; margin-top:5px;">To Link VFX, close this and use the VFX Rack below.</div>
        </div>
    </div>

    <div id="vhs-layer"></div>
    <div id="flash-layer"></div>
    <canvas id="canvas-layer"></canvas>
    <div id="logo-container"></div>
    <button id="toggle-ui" onclick="toggleUI()">OPEN ENGINE</button>

    <div id="ui-panel" id="panel">
        <h2>Phonk V30 <span style="font-size:9px; opacity:0.5">VFX RACK</span></h2>

        <div class="control-group">
            <label>Track</label>
            <input type="file" id="file-in" accept="audio/*">
            <button id="play-btn" onclick="togglePlay()" disabled style="width:100%; margin-top:5px; background:#111; border:1px solid #333; color:#555; padding:5px; cursor:pointer;">LOAD A SONG</button>
        </div>
        <div class="control-group">
            <label>Image</label>
            <input type="file" id="img-in" accept="image/*">
        </div>

        <h3>1. Frequency Architect</h3>
        <div class="sculptor-grid">
            <div class="sculpt-col">
                <div class="graph-area" id="graph-0" onmousedown="startDrag(0, event, 'main')"><div class="audio-bar" id="bar-0"></div><div class="thresh-line" id="line-0" style="bottom: 80%;"></div></div>
                <div class="col-controls">
                    <div class="react-indicator" id="ind-0"></div>
                    <button class="tweak-trigger-btn" onclick="openTweak(0)">Tweak</button>
                    <div class="gain-wrapper"><input type="range" class="v-slider" id="gain-0" min="0.5" max="4.0" step="0.1" value="1.0"></div>
                </div>
            </div>
            <div class="sculpt-col">
                <div class="graph-area" id="graph-1" onmousedown="startDrag(1, event, 'main')"><div class="audio-bar" id="bar-1"></div><div class="thresh-line" id="line-1" style="bottom: 60%;"></div></div>
                <div class="col-controls">
                    <div class="react-indicator" id="ind-1"></div>
                    <button class="tweak-trigger-btn" onclick="openTweak(1)">Tweak</button>
                    <div class="gain-wrapper"><input type="range" class="v-slider" id="gain-1" min="0.5" max="4.0" step="0.1" value="1.0"></div>
                </div>
            </div>
            <div class="sculpt-col">
                <div class="graph-area" id="graph-2" onmousedown="startDrag(2, event, 'main')"><div class="audio-bar" id="bar-2"></div><div class="thresh-line" id="line-2" style="bottom: 65%;"></div></div>
                <div class="col-controls">
                    <div class="react-indicator" id="ind-2"></div>
                    <button class="tweak-trigger-btn" onclick="openTweak(2)">Tweak</button>
                    <div class="gain-wrapper"><input type="range" class="v-slider" id="gain-2" min="0.5" max="4.0" step="0.1" value="1.0"></div>
                </div>
            </div>
            <div class="sculpt-col">
                <div class="graph-area" id="graph-3" onmousedown="startDrag(3, event, 'main')"><div class="audio-bar" id="bar-3"></div><div class="thresh-line" id="line-3" style="bottom: 85%;"></div></div>
                <div class="col-controls">
                    <div class="react-indicator" id="ind-3"></div>
                    <button class="tweak-trigger-btn" onclick="openTweak(3)">Tweak</button>
                    <div class="gain-wrapper"><input type="range" class="v-slider" id="gain-3" min="0.5" max="4.0" step="0.1" value="1.0"></div>
                </div>
            </div>
        </div>

        <div class="control-group">
            <label>Master Pre-Amp</label>
            <input type="range" id="pre-amp" min="0.5" max="3.0" step="0.1" value="1.0">
        </div>

        <h3>2. VFX Rack (New)</h3>
        <p style="font-size:9px; color:#555;">Click "Link" to bind effect to current selected bar.</p>
        
        <div class="vfx-row">
            <div class="vfx-name">RGB Split</div>
            <div class="vfx-controls">
                <input type="range" class="vfx-slider" id="amt-rgb" min="0" max="1" step="0.1" value="0.5">
                <button class="link-btn" id="link-rgb" onclick="linkVfx('rgb')">Link</button>
            </div>
        </div>

        <div class="vfx-row">
            <div class="vfx-name">Invert Flash</div>
            <div class="vfx-controls">
                <input type="range" class="vfx-slider" id="amt-invert" min="0" max="1" step="0.1" value="0">
                <button class="link-btn" id="link-invert" onclick="linkVfx('invert')">Link</button>
            </div>
        </div>

        <div class="vfx-row">
            <div class="vfx-name">VHS Noise</div>
            <div class="vfx-controls">
                <input type="range" class="vfx-slider" id="amt-vhs" min="0" max="1" step="0.1" value="0.3">
                <button class="link-btn" id="link-vhs" onclick="linkVfx('vhs')">Link</button>
            </div>
        </div>

        <div class="vfx-row">
            <div class="vfx-name">Mirror Kaleido</div>
            <div class="vfx-controls">
                <input type="range" class="vfx-slider" id="amt-mirror" min="0" max="1" step="0.1" value="0">
                <button class="link-btn" id="link-mirror" onclick="linkVfx('mirror')">Link</button>
            </div>
        </div>


        <h3>3. Geometry</h3>
        <div class="control-group"><label>Shape</label><select id="shape-select"><option value="square">Square</option><option value="triangle">Triangle</option><option value="round">Round</option></select></div>
        <div class="control-group"><label>Radius</label><input type="range" id="radius" min="100" max="350" value="170"></div>
        <div class="checkbox-row"><input type="checkbox" id="auto-color" checked onchange="toggleAutoColor()"><span style="font-size:10px;">Auto-Match Colors</span></div>

    </div>

    <input type="color" id="col-idle" value="#ffffff" style="display:none">
    <input type="color" id="col-bass" value="#ff0033" style="display:none">

    <script>
        const dom = {
            playBtn: document.getElementById('play-btn'),
            canvas: document.getElementById('canvas-layer'),
            ctx: document.getElementById('canvas-layer').getContext('2d'),
            logo: document.getElementById('logo-container'),
            flash: document.getElementById('flash-layer'),
            vhs: document.getElementById('vhs-layer'),
            panel: document.getElementById('ui-panel'),
            loader: document.getElementById('loader'),
            // Tweak DOM
            tweakModal: document.getElementById('tweak-modal'),
            tweakBar: document.getElementById('tweak-bar'),
            tweakThresh: document.getElementById('tweak-thresh'),
            tweakReactBtn: document.getElementById('tweak-react-btn'),
            inputs: { attack: document.getElementById('input-attack'), decay: document.getElementById('input-decay'), gate: document.getElementById('input-gate') },
            labels: { attack: document.getElementById('val-attack'), decay: document.getElementById('val-decay'), gate: document.getElementById('val-gate') },
            // VFX DOM
            vfxInputs: {
                rgb: document.getElementById('amt-rgb'),
                invert: document.getElementById('amt-invert'),
                vhs: document.getElementById('amt-vhs'),
                mirror: document.getElementById('amt-mirror')
            },
            vfxLinks: {
                rgb: document.getElementById('link-rgb'),
                invert: document.getElementById('link-invert'),
                vhs: document.getElementById('link-vhs'),
                mirror: document.getElementById('link-mirror')
            },
            // Main DOM
            bars: [0,1,2,3].map(i => document.getElementById(`bar-${i}`)),
            lines: [0,1,2,3].map(i => document.getElementById(`line-${i}`)),
            gains: [0,1,2,3].map(i => document.getElementById(`gain-${i}`)),
            inds: [0,1,2,3].map(i => document.getElementById(`ind-${i}`)),
            colIdle: document.getElementById('col-idle'),
            colBass: document.getElementById('col-bass'),
            autoColor: document.getElementById('auto-color'),
            preAmp: document.getElementById('pre-amp'),
            shapeSelect: document.getElementById('shape-select')
        };
        dom.canvas.width = window.innerWidth;
        dom.canvas.height = window.innerHeight;

        const state = {
            isPlaying: false,
            physics: 0,
            thresholds: [0.8, 0.6, 0.65, 0.85],
            extracted: { bass: '#ff0033', idle: '#ffffff' },
            reactIndex: -1, // Master Physics Link
            bandDSP: [
                { val: 0, attack: 0, decay: 0.15, gate: 0.05 },
                { val: 0, attack: 0, decay: 0.15, gate: 0.05 },
                { val: 0, attack: 0, decay: 0.15, gate: 0.05 },
                { val: 0, attack: 0, decay: 0.15, gate: 0.05 }
            ],
            // VFX Link Map: key=effectName, value=barIndex (-1 is Global/All)
            vfxLinks: { rgb: -1, invert: -1, vhs: -1, mirror: -1 },
            currentTweakIndex: -1 // Last clicked tweak button
        };

        // --- VFX LINKING ---
        window.linkVfx = (effectName) => {
            // If we have a bar selected in Tweak mode (or last opened), link it.
            // If currentTweakIndex is -1, we toggle between "Global" (-1) and "Off" (which we don't really have, so just Global)
            // Actually, let's just use the logic: If a Tweak window was opened last, link to that ID.
            
            if (state.currentTweakIndex === -1) {
                alert("Please click 'Tweak' on a frequency bar first to select it.");
                return;
            }
            
            // If already linked to this bar, unlink (set to -1/Global)
            if (state.vfxLinks[effectName] === state.currentTweakIndex) {
                state.vfxLinks[effectName] = -1;
            } else {
                state.vfxLinks[effectName] = state.currentTweakIndex;
            }
            updateVfxButtons();
        };

        function updateVfxButtons() {
            for (const [key, btn] of Object.entries(dom.vfxLinks)) {
                const linkedIdx = state.vfxLinks[key];
                if (linkedIdx !== -1) {
                    btn.classList.add('linked');
                    btn.innerText = `LINKED ${linkedIdx*20+20}Hz`;
                } else {
                    btn.classList.remove('linked');
                    btn.innerText = "Global";
                }
            }
        }

        // --- TWEAK & UI LOGIC ---
        window.openTweak = (idx) => {
            state.currentTweakIndex = idx;
            document.getElementById('tweak-band-id').innerText = (idx * 20 + 20) + "Hz";
            dom.tweakThresh.style.bottom = (state.thresholds[idx] * 100) + "%";
            
            const dsp = state.bandDSP[idx];
            dom.inputs.attack.value = dsp.attack;
            dom.inputs.decay.value = dsp.decay;
            dom.inputs.gate.value = dsp.gate;
            
            updateKnobs();
            updateReactUI();
            dom.tweakModal.classList.add('active');
        };

        window.closeTweak = () => { dom.tweakModal.classList.remove('active'); }; // Don't reset index so we can link VFX
        window.updateKnobs = () => {
            if(state.currentTweakIndex === -1) return;
            const idx = state.currentTweakIndex;
            state.bandDSP[idx].attack = parseFloat(dom.inputs.attack.value);
            state.bandDSP[idx].decay = parseFloat(dom.inputs.decay.value);
            state.bandDSP[idx].gate = parseFloat(dom.inputs.gate.value);
            dom.labels.attack.innerText = state.bandDSP[idx].attack.toFixed(2);
            dom.labels.decay.innerText = state.bandDSP[idx].decay.toFixed(2);
            dom.labels.gate.innerText = state.bandDSP[idx].gate.toFixed(2);
        };
        window.toggleReact = () => {
            if(state.currentTweakIndex === -1) return;
            state.reactIndex = (state.reactIndex === state.currentTweakIndex) ? -1 : state.currentTweakIndex;
            updateReactUI(); updateGridIndicators();
        };
        function updateReactUI() {
            if(state.reactIndex === state.currentTweakIndex) { dom.tweakReactBtn.classList.add('active'); dom.tweakReactBtn.innerText = "PHYSICS LINKED (UNLINK)"; }
            else { dom.tweakReactBtn.classList.remove('active'); dom.tweakReactBtn.innerText = "LINK MASTER PHYSICS"; }
        }
        function updateGridIndicators() {
            dom.inds.forEach((ind, i) => {
                if(i === state.reactIndex) ind.classList.add('active'); else ind.classList.remove('active');
            });
        }

        // --- DRAG LOGIC ---
        let dragTarget = -1; let dragMode = '';
        window.startDrag = (index, e, mode) => {
            if(mode === 'tweak' && state.currentTweakIndex !== -1) dragTarget = state.currentTweakIndex; else dragTarget = index;
            dragMode = mode; updateDrag(e);
            document.addEventListener('mousemove', onDrag); document.addEventListener('mouseup', endDrag);
        }
        function onDrag(e) { if(dragTarget !== -1) updateDrag(e); }
        function endDrag() { dragTarget = -1; document.removeEventListener('mousemove', onDrag); document.removeEventListener('mouseup', endDrag); }
        function updateDrag(e) {
            const elId = (dragMode === 'tweak') ? 'tweak-graph' : `graph-${dragTarget}`;
            const rect = document.getElementById(elId).getBoundingClientRect();
            let y = 1.0 - ((e.clientY - rect.top) / rect.height);
            if (y < 0) y = 0; if (y > 1) y = 1;
            state.thresholds[dragTarget] = y;
            dom.lines[dragTarget].style.bottom = (y * 100) + "%";
            if(state.currentTweakIndex === dragTarget) dom.tweakThresh.style.bottom = (y * 100) + "%";
        }

        // --- AUDIO ENGINE ---
        let audioCtx, source, analyser, audioBuffer;
        document.getElementById('file-in').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if(!file) return;
            dom.loader.classList.add('active'); dom.playBtn.disabled = true; dom.playBtn.innerText = "ANALYZING...";
            const arrayBuffer = await file.arrayBuffer();
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            try { audioBuffer = await audioCtx.decodeAudioData(arrayBuffer); analyzeTrack(audioBuffer); } 
            catch (err) { console.error(err); dom.loader.classList.remove('active'); }
        });

        function analyzeTrack(buffer) {
            const raw = buffer.getChannelData(0); let sum = 0;
            for (let i=0; i<raw.length; i+=10000) sum += Math.abs(raw[i]);
            dom.preAmp.value = (sum / (raw.length/10000) < 0.1) ? 2.0 : 1.0;
            if (source) source.disconnect();
            dom.loader.classList.remove('active'); dom.playBtn.disabled = false; dom.playBtn.innerText = "PLAY TRACK";
        }

        window.togglePlay = () => {
            if(!audioBuffer) return;
            if(state.isPlaying) { if(source) source.stop(); state.isPlaying = false; dom.playBtn.innerText = "PLAY TRACK"; } 
            else {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                source = audioCtx.createBufferSource(); source.buffer = audioBuffer;
                analyser = audioCtx.createAnalyser(); analyser.fftSize = 2048;
                source.connect(analyser); source.connect(audioCtx.destination);
                source.start(0); state.isPlaying = true; dom.playBtn.innerText = "STOP TRACK"; loop();
            }
        }

        function loop() {
            if(!state.isPlaying) return;
            requestAnimationFrame(loop);
            const bufferLen = analyser.frequencyBinCount; 
            const data = new Uint8Array(bufferLen);
            analyser.getByteFrequencyData(data);
            const masterPre = parseFloat(dom.preAmp.value); 
            const rawBands = [data[1], data[2], data[3], data[4]];
            
            let totalPhysics = 0;

            // Values for FX triggering
            let vfxTriggers = [0, 0, 0, 0]; 

            rawBands.forEach((rawVal, i) => {
                let input = (rawVal / 255) * masterPre * parseFloat(dom.gains[i].value);
                const dsp = state.bandDSP[i];
                if(input < dsp.gate) input = 0;
                
                let current = dsp.val;
                if (input > current) current += (input - current) * (1.0 - dsp.attack);
                else current -= dsp.decay;
                if(current < 0) current = 0;
                
                state.bandDSP[i].val = current;
                let processedVal = Math.min(current, 1);

                // UI
                dom.bars[i].style.height = (processedVal * 100) + "%";
                dom.bars[i].style.backgroundColor = (processedVal > state.thresholds[i]) ? dom.colBass.value : '#444';
                if(state.currentTweakIndex === i) {
                    dom.tweakBar.style.height = (processedVal * 100) + "%";
                    dom.tweakBar.style.backgroundColor = (processedVal > state.thresholds[i]) ? '#fff' : dom.colBass.value;
                }

                // PHYSICS & VFX TRIGGER
                const thresh = state.thresholds[i];
                let force = 0;
                if (processedVal > thresh) force = (processedVal - thresh);
                
                vfxTriggers[i] = force; // Store force for VFX Logic

                if (state.reactIndex !== -1) {
                    if (state.reactIndex === i) totalPhysics = force * 3.0;
                } else {
                    totalPhysics += force;
                }
            });

            // Physics Smoothing
            if (totalPhysics > state.physics) state.physics = totalPhysics; else state.physics *= 0.82;
            state.physics = Math.min(Math.max(state.physics, 0), 2.5);

            draw(data, bufferLen, state.physics);
            applyFx(state.physics, vfxTriggers);
        }

        function draw(data, count, phys) {
            const ctx = dom.ctx;
            const cx = dom.canvas.width / 2;
            const cy = dom.canvas.height / 2;
            const baseRad = parseInt(document.getElementById('radius').value);
            const maxLen = 160; const w = 25;
            const shape = dom.shapeSelect.value;
            const pre = parseFloat(dom.preAmp.value);

            // RGB SPLIT FX
            let rgbOffset = 0;
            const rgbLink = state.vfxLinks.rgb;
            const rgbAmt = parseFloat(dom.vfxInputs.rgb.value);
            if(rgbAmt > 0) {
                 // Check if triggered globally or by specific bar
                 let trigger = (rgbLink === -1) ? phys : state.bandDSP[rgbLink].val > state.thresholds[rgbLink] ? (state.bandDSP[rgbLink].val - state.thresholds[rgbLink]) * 2 : 0;
                 rgbOffset = trigger * (rgbAmt * 20);
            }

            // MIRROR FX
            let mirrorMode = false;
            const mirrorLink = state.vfxLinks.mirror;
            const mirrorAmt = parseFloat(dom.vfxInputs.mirror.value);
            if(mirrorAmt > 0) {
                let trigger = (mirrorLink === -1) ? phys : state.bandDSP[mirrorLink].val > state.thresholds[mirrorLink] ? 1 : 0;
                if(trigger > 0.1) mirrorMode = true;
            }

            const cIdle = hexToRgb(dom.colIdle.value);
            const cBass = hexToRgb(dom.colBass.value);
            let flashMix = Math.min(phys, 1);
            
            // DRAW LOOP (Run twice for RGB effect if needed, but for performance, we just offset draws)
            // Simplified RGB: We just draw once, but shift context? No, for true RGB split we need composite operations.
            // Let's do a simple "Shake RGB" simulation:
            
            ctx.clearRect(0, 0, dom.canvas.width, dom.canvas.height);

            // MIRROR transform
            ctx.save();
            if(mirrorMode) {
                ctx.translate(cx, cy);
                ctx.scale(1, -1); // Flip Y
                ctx.translate(-cx, -cy);
            }

            const rad = baseRad + (phys * 30); 
            const totalBars = 60;
            const angleStep = Math.PI / totalBars; 

            // Standard Draw
            for(let i = 0; i < totalBars; i++) {
                let index = 2 + i * 2;
                let val = (data[index] / 255) * pre; if(val > 1) val = 1;
                let h = val * maxLen;
                if (state.reactIndex !== -1) h = h * (0.3 + (phys * 0.7));
                if(h < 4) h = 4;

                // COLOR LOGIC
                ctx.fillStyle = `rgb(${cIdle.r + (cBass.r - cIdle.r) * flashMix},${cIdle.g + (cBass.g - cIdle.g) * flashMix},${cIdle.b + (cBass.b - cIdle.b) * flashMix})`;
                
                // RGB DRAW (Cyan)
                if(rgbOffset > 1) {
                    ctx.fillStyle = "rgba(0,255,255,0.8)";
                    drawBar(ctx, cx - rgbOffset, cy, rad, w, h, (i * angleStep) - (Math.PI/2), shape);
                    drawBar(ctx, cx - rgbOffset, cy, rad, w, h, -(i * angleStep) - (Math.PI/2), shape);
                }
                
                // RGB DRAW (Red)
                if(rgbOffset > 1) {
                    ctx.fillStyle = "rgba(255,0,0,0.8)";
                    drawBar(ctx, cx + rgbOffset, cy, rad, w, h, (i * angleStep) - (Math.PI/2), shape);
                    drawBar(ctx, cx + rgbOffset, cy, rad, w, h, -(i * angleStep) - (Math.PI/2), shape);
                } else {
                    // Normal Draw
                    drawBar(ctx, cx, cy, rad, w, h, (i * angleStep) - (Math.PI/2), shape);
                    drawBar(ctx, cx, cy, rad, w, h, -(i * angleStep) - (Math.PI/2), shape);
                }
            }
            ctx.restore();
        }

        function drawBar(ctx, cx, cy, rad, w, h, angle, shape) {
            ctx.save(); ctx.translate(cx, cy); ctx.rotate(angle); ctx.beginPath();
            if(shape === 'square') ctx.rect(rad, -w/2, h, w);
            else if (shape === 'triangle') { ctx.moveTo(rad, -w/2); ctx.lineTo(rad + h, 0); ctx.lineTo(rad, w/2); }
            else if (shape === 'round') { if(ctx.roundRect) ctx.roundRect(rad, -w/2, h, w, w/2); else ctx.rect(rad, -w/2, h, w); }
            ctx.fill(); ctx.restore();
        }

        function applyFx(globalPhys, triggers) {
            // Shake
            let x=0, y=0;
            if(globalPhys > 0.01) {
                 const shake = globalPhys * 20; 
                 x = (Math.random()-0.5) * shake; y = (Math.random()-0.5) * shake;
            }
            dom.logo.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px)) scale(${1 + globalPhys*0.1})`;
            dom.logo.style.borderColor = `rgba(255,255,255,${0.05 + globalPhys})`;

            // INVERT FX
            const invLink = state.vfxLinks.invert;
            const invAmt = parseFloat(dom.vfxInputs.invert.value);
            let invTrigger = (invLink === -1) ? globalPhys : (triggers[invLink] || 0);
            
            if (invAmt > 0 && invTrigger > 0.2) {
                dom.flash.style.opacity = invTrigger * invAmt;
                dom.flash.style.mixBlendMode = 'exclusion'; // Invert effect
            } else {
                dom.flash.style.opacity = 0;
            }

            // VHS FX
            const vhsLink = state.vfxLinks.vhs;
            const vhsAmt = parseFloat(dom.vfxInputs.vhs.value);
            let vhsTrigger = (vhsLink === -1) ? globalPhys : (triggers[vhsLink] || 0);
            
            if (vhsAmt > 0) {
                dom.vhs.style.opacity = (0.2 + (vhsTrigger * vhsAmt)); // Always slightly visible, spikes on beat
                dom.vhs.style.filter = `contrast(${1 + vhsTrigger}) brightness(${1 + vhsTrigger*0.5})`;
            } else {
                dom.vhs.style.opacity = 0;
            }
        }

        function hexToRgb(hex) { const bigint = parseInt(hex.replace('#',''), 16); return { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255 }; }
        window.toggleUI = () => dom.panel.classList.toggle('hidden');
        window.toggleAutoColor = () => { if(dom.autoColor.checked) { dom.colBass.value = state.extracted.bass; dom.colIdle.value = state.extracted.idle; } }

        document.getElementById('img-in').addEventListener('change', e => {
            const u = URL.createObjectURL(e.target.files[0]);
            dom.logo.style.backgroundImage = `url(${u})`;
            const i = new Image(); i.src = u;
            i.onload = () => {
                const c = document.createElement('canvas'); const x = c.getContext('2d');
                c.width=i.width; c.height=i.height; x.drawImage(i,0,0);
                const p1 = x.getImageData(i.width/2, i.height/2, 1, 1).data; 
                const p2 = x.getImageData(10, 10, 1, 1).data; 
                state.extracted.bass = "#" + ((1<<24)+(p1[0]<<16)+(p1[1]<<8)+p1[2]).toString(16).slice(1);
                state.extracted.idle = "#" + ((1<<24)+(p2[0]<<16)+(p2[1]<<8)+p2[2]).toString(16).slice(1);
                if(dom.autoColor.checked) { dom.colBass.value = state.extracted.bass; dom.colIdle.value = state.extracted.idle; }
            }
        });
        window.onresize = () => { dom.canvas.width=window.innerWidth; dom.canvas.height=window.innerHeight; }
    </script>
</body>
</html>
