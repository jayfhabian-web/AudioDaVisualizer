<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AudioDaVisualizer V19 - Auto Bass</title>
    <style>
        /* --- THEME --- */
        :root {
            --bg: #050505;
            --panel: rgba(15, 15, 15, 0.96);
            --border: rgba(255, 255, 255, 0.1);
            --primary: #ff0055; 
            --accent: #00e5ff;
            --text: #e0e0e0;
        }

        body { margin: 0; background: var(--bg); font-family: 'Segoe UI', sans-serif; overflow: hidden; color: var(--text); }
        
        #flash-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; opacity: 0; mix-blend-mode: overlay; transition: opacity 0.1s; }
        #canvas-layer { position: absolute; top: 0; left: 0; z-index: 1; }
        
        #logo-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; height: 300px; z-index: 5; border-radius: 50%; 
            background-size: cover; background-position: center;
            box-shadow: 0 0 60px rgba(0,0,0,0.8);
            will-change: transform; 
        }

        /* UI PANEL */
        #ui-panel {
            position: absolute; top: 0; left: 0; width: 340px; height: 100vh;
            background: var(--panel); border-right: 1px solid var(--border);
            padding: 25px; box-sizing: border-box; z-index: 20; overflow-y: auto;
            transition: transform 0.3s ease;
        }
        #ui-panel.hidden { transform: translateX(-100%); }

        /* HEADERS */
        h2 { 
            font-size: 20px; color: #fff; margin: 0 0 25px 0; 
            border-left: 4px solid var(--primary); padding-left: 10px;
            text-transform: uppercase; font-weight: 900; letter-spacing: 1px;
            outline: none; cursor: text;
        }
        h3 { font-size: 11px; text-transform: uppercase; color: #777; margin-top: 30px; border-bottom: 1px solid #333; padding-bottom: 5px; font-weight: 700; letter-spacing: 1px; }

        /* CONTROLS */
        .control-group { margin-bottom: 20px; }
        label { display: flex; justify-content: space-between; font-size: 11px; color: #ccc; margin-bottom: 8px; font-weight: 600; }
        
        .status-tag { font-size: 9px; padding: 2px 6px; border-radius: 4px; background: #333; color: #aaa; text-transform: uppercase; }
        .status-tag.active { background: var(--primary); color: white; }

        input[type="range"] { width: 100%; height: 5px; background: #222; border-radius: 3px; appearance: none; cursor: pointer; border: 1px solid #333; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 14px; height: 14px; background: #fff; border-radius: 50%; box-shadow: 0 0 10px rgba(255,255,255,0.3); transition: transform 0.1s; }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        
        input[type="file"] { width: 100%; background: #1a1a1a; border: 1px solid #333; color: #888; padding: 10px; border-radius: 6px; font-size: 11px; }
        input[type="color"] { width: 100%; height: 35px; border: none; background: none; cursor: pointer; padding: 0; }
        
        .checkbox-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; background: #1a1a1a; padding: 10px; border-radius: 6px; border: 1px solid #2a2a2a; }
        input[type="checkbox"] { accent-color: var(--primary); transform: scale(1.1); }

        /* ANALYZER METER */
        .meter-container { height: 30px; background: #000; border-radius: 4px; position: relative; overflow: hidden; margin-top: 5px; border: 1px solid #333; }
        .meter-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #333, var(--primary)); opacity: 0.5; transition: width 0.05s; }
        .meter-peak { position: absolute; top: 0; bottom: 0; width: 2px; background: #fff; opacity: 0.5; }
        .meter-thresh { position: absolute; top: 0; bottom: 0; width: 2px; background: var(--accent); z-index: 5; box-shadow: 0 0 8px var(--accent); transition: left 0.2s; }
        .meter-val { position: absolute; right: 5px; top: 8px; font-size: 10px; color: white; font-weight: bold; z-index: 6; text-shadow: 0 0 4px black; }

        /* HIDE BTN */
        #toggle-ui { position: absolute; top: 20px; left: 360px; z-index: 25; background: #111; color: white; border: 1px solid #444; padding: 8px 16px; cursor: pointer; border-radius: 20px; font-size: 11px; transition: left 0.3s; font-weight: bold; }
        #ui-panel.hidden + #toggle-ui { left: 20px; }
    </style>
</head>
<body>

    <div id="flash-layer"></div>
    <canvas id="canvas-layer"></canvas>
    <div id="logo-container"></div>
    <button id="toggle-ui" onclick="toggleUI()">Hide Controls</button>

    <div id="ui-panel" id="panel">
        <h2 contenteditable="true" spellcheck="false">AudioDaVisualizer</h2>

        <div class="control-group">
            <label>Audio Track</label>
            <input type="file" id="file-in" accept="audio/*">
            <audio id="audio" controls style="width:100%; margin-top:8px; height:30px; opacity:0.8;"></audio>
        </div>
        <div class="control-group">
            <label>Logo / Cover Art</label>
            <input type="file" id="img-in" accept="image/*">
        </div>

        <h3>1. Smart Audio Engine</h3>
        
        <div class="control-group">
            <label>
                <span>Live Analysis</span>
                <span id="status-badge" class="status-tag">IDLE</span>
            </label>
            <div class="meter-container">
                <div id="m-fill" class="meter-fill"></div>
                <div id="m-peak" class="meter-peak" style="left:0%"></div>
                <div id="m-thresh" class="meter-thresh" style="left:50%"></div>
                <span class="meter-val" id="db-val">-inf dB</span>
            </div>
            <div style="font-size:10px; color:#666; margin-top:5px; display:flex; justify-content:space-between;">
                <span>Blue Line = Auto Threshold</span>
                <span>White Line = Max Peak</span>
            </div>
        </div>

        <div class="control-group">
            <label>Reaction Sensitivity (Only change this!)</label>
            <input type="range" id="sens" min="0.5" max="1.5" step="0.05" value="1.0">
            <div style="font-size:9px; color:#555; margin-top:4px;">Left: Needs LOUD bass to trigger â€¢ Right: Reacts to everything</div>
        </div>

        <div class="control-group">
            <label>Movement Decay (Smoothness)</label>
            <input type="range" id="decay" min="0.5" max="0.95" step="0.01" value="0.80">
        </div>

        <h3>2. Visual Structure</h3>
        <div class="checkbox-row">
            <input type="checkbox" id="auto-color" checked onchange="toggleAutoColor()">
            <span style="font-size:11px;font-weight:bold;">Auto-Extract Colors</span>
        </div>
        <div id="manual-colors" style="display:none; margin-bottom:15px;">
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>Bass Color</label><input type="color" id="col-bass" value="#ff0055"></div>
                <div style="flex:1"><label>Rest Color</label><input type="color" id="col-audio" value="#ffffff"></div>
            </div>
        </div>

        <div class="control-group">
            <label>Bar Thickness</label>
            <input type="range" id="bar-width" min="2" max="40" value="18">
        </div>
        <div class="control-group">
            <label>Bar Spacing</label>
            <input type="range" id="bar-gap" min="0" max="10" value="2">
        </div>
        <div class="control-group">
            <label>Ring Radius</label>
            <input type="range" id="radius" min="100" max="350" value="160">
        </div>

        <h3>3. Effects</h3>
        <div class="checkbox-row" style="flex-wrap:wrap;">
            <label style="margin-right:15px; cursor:pointer;"><input type="checkbox" id="fx-zoom" checked> Zoom</label>
            <label style="margin-right:15px; cursor:pointer;"><input type="checkbox" id="fx-shake" checked> Shake</label>
            <label style="cursor:pointer;"><input type="checkbox" id="fx-flash" checked> Flash</label>
        </div>
        <div class="control-group">
            <label>Effect Intensity</label>
            <input type="range" id="fx-int" min="0" max="2" step="0.1" value="1.0">
        </div>
    </div>

    <script>
        // --- DOM REFS ---
        const dom = {
            audio: document.getElementById('audio'),
            canvas: document.getElementById('canvas-layer'),
            ctx: document.getElementById('canvas-layer').getContext('2d'),
            logo: document.getElementById('logo-container'),
            flash: document.getElementById('flash-layer'),
            panel: document.getElementById('ui-panel'),
            // Meter Refs
            mFill: document.getElementById('m-fill'),
            mPeak: document.getElementById('m-peak'),
            mThresh: document.getElementById('m-thresh'),
            dbVal: document.getElementById('db-val'),
            status: document.getElementById('status-badge'),
            // Colors
            colBass: document.getElementById('col-bass'),
            colAudio: document.getElementById('col-audio'),
            autoColor: document.getElementById('auto-color')
        };
        dom.canvas.width = window.innerWidth;
        dom.canvas.height = window.innerHeight;

        // --- STATE & ANALYSIS VARS ---
        const state = {
            connected: false,
            physics: 0,
            extracted: { bass: '#ff0055', audio: '#ffffff' },
            // Auto-Gain Logic
            avgVol: 0,      // Rolling average of volume
            peakVol: 100,   // Highest volume seen recently
            frame: 0
        };

        let audioCtx, source, analyser;

        // --- INIT AUDIO ---
        dom.audio.addEventListener('play', () => {
            if(state.connected) { if(audioCtx.state === 'suspended') audioCtx.resume(); return; }
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            source = audioCtx.createMediaElementSource(dom.audio);
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 256; 
            source.connect(analyser);
            source.connect(audioCtx.destination); 
            state.connected = true;
            dom.status.innerText = "LISTENING...";
            dom.status.classList.add('active');
            loop();
        });

        dom.audio.addEventListener('pause', () => {
             dom.status.innerText = "PAUSED";
             dom.status.classList.remove('active');
        });

        // --- MAIN ENGINE LOOP ---
        function loop() {
            requestAnimationFrame(loop);
            const buffer = analyser.frequencyBinCount;
            const data = new Uint8Array(buffer);
            analyser.getByteFrequencyData(data);
            state.frame++;

            // 1. SMART ANALYSIS (The Brain)
            // Get Deep Bass Average (0-4 bins)
            let bassSum = 0;
            for(let i=0; i<5; i++) bassSum += data[i];
            let currentBass = bassSum / 5;

            // Rolling Average (Slowly learns the "Floor" noise level)
            state.avgVol = (state.avgVol * 0.99) + (currentBass * 0.01);

            // Peak Tracking (Slowly learns the "Ceiling" max volume)
            if(currentBass > state.peakVol) state.peakVol = currentBass; 
            else state.peakVol *= 0.999; // Slowly decay peak so it adapts if song gets quieter

            // 2. DYNAMIC THRESHOLD CALCULATION
            // The threshold is not fixed. It moves based on the song's average volume.
            // "Sensitivity" slider adjusts how far above the average we need to be to trigger.
            const sens = parseFloat(document.getElementById('sens').value);
            
            // This is the Magic Formula:
            // Threshold = Average + (Distance to Peak * (1.5 - Sensitivity))
            // Basically: "Trigger somewhere between the average noise and the max peak"
            let dynamicThresh = state.avgVol + ((state.peakVol - state.avgVol) * (1.5 - sens) * 0.6);

            // 3. CALCULATE FORCE
            let force = 0;
            if (currentBass > dynamicThresh) {
                // How far over the line are we? (Normalized 0.0 to 1.0)
                let headroom = state.peakVol - dynamicThresh;
                if(headroom < 1) headroom = 1; // Safety
                force = (currentBass - dynamicThresh) / headroom;
            }

            // 4. UPDATE UI DEBUGGER (So you can see it thinking)
            dom.mFill.style.width = (currentBass / 255 * 100) + "%";
            dom.mPeak.style.left = (state.peakVol / 255 * 100) + "%";
            dom.mThresh.style.left = (dynamicThresh / 255 * 100) + "%";
            
            if(state.frame % 10 === 0) { // Update text less often
                dom.dbVal.innerText = Math.round(currentBass) + " / " + Math.round(dynamicThresh);
            }

            // 5. PHYSICS SMOOTHING
            const decay = parseFloat(document.getElementById('decay').value);
            if(force > state.physics) state.physics = force; // Instant Attack
            else state.physics *= decay; // Smooth Release
            
            // Hard Clamp (0.0 - 2.0)
            if(state.physics < 0.001) state.physics = 0;
            if(state.physics > 2.0) state.physics = 2.0;

            // 6. DRAW & FX
            draw(data, buffer, state.physics);
            applyFx(state.physics);
        }

        function draw(data, count, phys) {
            const ctx = dom.ctx;
            const cx = dom.canvas.width / 2;
            const cy = dom.canvas.height / 2;
            const rad = parseInt(document.getElementById('radius').value) + (phys * 20);
            
            const w = parseFloat(document.getElementById('bar-width').value);
            const gap = parseFloat(document.getElementById('bar-gap').value);
            const cBass = dom.colBass.value;
            const cAudio = dom.colAudio.value;

            ctx.clearRect(0, 0, dom.canvas.width, dom.canvas.height);
            const angleStep = (2 * Math.PI) / count;

            for(let i = 0; i < count; i++) {
                // Height is normalized by our learnt Peak Volume
                // This ensures quiet songs still look big, and loud songs don't explode
                let val = data[i];
                let normVal = val / state.peakVol; // Normalize
                if(normVal > 1) normVal = 1;
                
                let h = normVal * 120;

                // Bass Bars
                if (i < 8) { 
                    ctx.fillStyle = cBass;
                    h *= (1 + (phys * 0.8)); 
                } else {
                    ctx.fillStyle = cAudio;
                }

                if (h > 2) {
                    const ang = (i * angleStep) - (Math.PI / 2);
                    ctx.save();
                    ctx.translate(cx, cy);
                    ctx.rotate(ang);
                    roundRect(ctx, -w/2, rad + gap, w, h, 6);
                    ctx.restore();
                }
            }
        }

        function applyFx(p) {
            const mag = parseFloat(document.getElementById('fx-int').value);
            let s=1, x=0, y=0, f=0;

            if (p > 0.01) {
                if(document.getElementById('fx-zoom').checked) s += (p * 0.2 * mag);
                if(document.getElementById('fx-shake').checked) {
                    const shake = p * 15 * mag;
                    x = (Math.random()-0.5) * shake;
                    y = (Math.random()-0.5) * shake;
                }
                if(document.getElementById('fx-flash').checked) f = p * 0.5 * mag;
            }

            dom.logo.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px)) scale(${s})`;
            dom.flash.style.opacity = f;
        }

        function roundRect(ctx, x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            ctx.beginPath();
            ctx.moveTo(x+r, y);
            ctx.arcTo(x+w, y,   x+w, y+h, r);
            ctx.arcTo(x+w, y+h, x,   y+h, r);
            ctx.arcTo(x,   y+h, x,   y,   r);
            ctx.arcTo(x,   y,   x+w, y,   r);
            ctx.closePath();
            ctx.fill();
        }

        // --- UTILS ---
        window.toggleUI = () => dom.panel.classList.toggle('hidden');
        window.toggleAutoColor = () => {
            const a = dom.autoColor.checked;
            document.getElementById('manual-colors').style.display = a ? 'none' : 'block';
            if(a) { dom.colBass.value = state.extracted.bass; dom.colAudio.value = state.extracted.audio; }
        }

        document.getElementById('img-in').addEventListener('change', e => {
            const u = URL.createObjectURL(e.target.files[0]);
            dom.logo.style.backgroundImage = `url(${u})`;
            const i = new Image(); i.src = u;
            i.onload = () => {
                const c = document.createElement('canvas'); const x = c.getContext('2d');
                c.width=i.width; c.height=i.height; x.drawImage(i,0,0);
                const p1 = x.getImageData(i.width/2, i.height/2, 1, 1).data;
                const p2 = x.getImageData(10, 10, 1, 1).data;
                state.extracted.bass = "#" + ((1<<24)+(p1[0]<<16)+(p1[1]<<8)+p1[2]).toString(16).slice(1);
                state.extracted.audio = "#" + ((1<<24)+(p2[0]<<16)+(p2[1]<<8)+p2[2]).toString(16).slice(1);
                if(dom.autoColor.checked) { dom.colBass.value = state.extracted.bass; dom.colAudio.value = state.extracted.audio; }
            }
        });
        document.getElementById('file-in').addEventListener('change', e => { dom.audio.src = URL.createObjectURL(e.target.files[0]); dom.audio.play(); });
        window.onresize = () => { dom.canvas.width=window.innerWidth; dom.canvas.height=window.innerHeight; }
    </script>
</body>
</html>
