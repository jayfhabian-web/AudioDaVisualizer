<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PhonkVisualizer Pro</title>
    <style>
        /* --- POLISHED UI STYLING --- */
        body { margin: 0; background: #050505; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; color: white; }
        
        #canvas-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
        }

        /* The Background Image Layer (Separate so we can zoom it smoothly) */
        #bg-layer {
            position: absolute; top: -5%; left: -5%; width: 110%; height: 110%; z-index: 0;
            background-size: cover; background-position: center;
            filter: blur(8px) brightness(0.4); /* Darkened and Blurred for polish */
            transition: transform 0.1s linear; /* Smooth hardware acceleration */
        }

        /* The Center Logo */
        #logo-container {
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            z-index: 2;
            width: 300px; height: 300px;
            display: flex; justify-content: center; align-items: center;
        }

        #logo {
            width: 100%; height: 100%; 
            border-radius: 50%; 
            background-size: cover; background-position: center;
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.1); /* Subtle ring */
        }

        /* Controls UI */
        #ui-controls {
            position: absolute; bottom: 20px; left: 20px; z-index: 10;
            background: rgba(15, 15, 15, 0.85); 
            backdrop-filter: blur(10px);
            padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
            width: 280px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: opacity 0.3s;
        }
        #ui-controls:hover { opacity: 1; }
        
        h2 { margin: 0 0 15px 0; font-size: 16px; letter-spacing: 1px; color: #ff0055; text-transform: uppercase; }
        
        .control-group { margin-bottom: 12px; }
        label { display: block; font-size: 11px; color: #888; margin-bottom: 4px; uppercase; }
        select, input[type="file"], input[type="range"] { width: 100%; background: #222; border: 1px solid #444; color: white; padding: 5px; border-radius: 4px; }
        input[type="range"] { cursor: pointer; }

        button {
            background: linear-gradient(45deg, #ff0055, #ff0033);
            border: none; color: white; padding: 10px; width: 100%; border-radius: 6px;
            font-weight: bold; cursor: pointer; margin-top: 10px;
            box-shadow: 0 4px 15px rgba(255, 0, 85, 0.3);
        }
        button:active { transform: scale(0.98); }
    </style>
</head>
<body>

    <div id="bg-layer" style="background-image: url('https://images.unsplash.com/photo-1614726365723-49faaa5f1b1b?q=80&w=1920&auto=format&fit=crop');"></div>

    <canvas id="canvas-layer"></canvas>

    <div id="logo-container">
        <div id="logo" style="background-image: url('https://images.unsplash.com/photo-1614726365723-49faaa5f1b1b?q=80&w=500&auto=format&fit=crop');"></div>
    </div>

    <div id="ui-controls">
        <h2>Phonk Engine V3</h2>
        
        <div class="control-group">
            <label>Upload Audio</label>
            <input type="file" id="audio-input" accept="audio/*">
        </div>
        
        <div class="control-group">
            <label>Reaction Mode</label>
            <select id="mode-select">
                <option value="bass">Bass Only (Kick/Sub)</option>
                <option value="all">Full Audio (Vocals/Melody)</option>
            </select>
        </div>

        <div class="control-group">
            <label>Shake Intensity</label>
            <input type="range" id="intensity" min="0" max="3" step="0.1" value="1.5">
        </div>

        <div class="control-group">
            <label>Customize Images</label>
            <input type="file" id="logo-input" accept="image/*" style="margin-bottom:5px">
            <input type="file" id="bg-input" accept="image/*">
        </div>

        <button id="toggle-ui">Hide Controls (Press H)</button>
    </div>

    <script>
        // --- SETUP ---
        const canvas = document.getElementById('canvas-layer');
        const ctx = canvas.getContext('2d');
        const bgLayer = document.getElementById('bg-layer');
        const logoContainer = document.getElementById('logo-container');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Variables for Audio
        let audioCtx, audioSrc, analyser;
        let isPlaying = false;
        
        // Variables for Smoothing (The "Polish")
        let currentScale = 1;
        let targetScale = 1;
        const smoothingFactor = 0.15; // Lower = smoother, Higher = snappier

        // --- AUDIO INPUT HANDLER ---
        document.getElementById('audio-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;

            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            const reader = new FileReader();
            reader.onload = function(ev) {
                audioCtx.decodeAudioData(ev.target.result, function(buffer) {
                    if(audioSrc) audioSrc.disconnect();
                    audioSrc = audioCtx.createBufferSource();
                    audioSrc.buffer = buffer;

                    analyser = audioCtx.createAnalyser();
                    analyser.fftSize = 256; // 128 bars
                    analyser.smoothingTimeConstant = 0.8; // Built-in WebAudio smoothing

                    audioSrc.connect(analyser);
                    analyser.connect(audioCtx.destination);
                    audioSrc.start(0);
                    isPlaying = true;
                    render();
                });
            };
            reader.readAsArrayBuffer(file);
        });

        // --- IMAGE HANDLERS ---
        document.getElementById('logo-input').addEventListener('change', (e) => {
            const url = URL.createObjectURL(e.target.files[0]);
            document.getElementById('logo').style.backgroundImage = `url(${url})`;
        });
        document.getElementById('bg-input').addEventListener('change', (e) => {
            const url = URL.createObjectURL(e.target.files[0]);
            bgLayer.style.backgroundImage = `url(${url})`;
            document.getElementById('logo').style.backgroundImage = `url(${url})`; // Default center to match
        });

        // --- MAIN RENDER LOOP ---
        function render() {
            if(!isPlaying) return;
            requestAnimationFrame(render);

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 1. DETERMINE "ENERGY" BASED ON MODE
            const mode = document.getElementById('mode-select').value;
            let energy = 0;

            if (mode === 'bass') {
                // Focus on indices 0 to 4 (Deep Bass ~0-100Hz)
                let bassSum = 0;
                for(let i = 0; i < 5; i++) bassSum += dataArray[i];
                energy = bassSum / 5; 
            } else {
                // Focus on indices 0 to 100 (Full Spectrum)
                let allSum = 0;
                for(let i = 0; i < 100; i++) allSum += dataArray[i];
                energy = allSum / 100;
            }

            // 2. MATH: SMOOTHING (LERP)
            // Instead of jumping to the new value, we move 15% of the way there every frame.
            const sensitivity = document.getElementById('intensity').value;
            targetScale = 1 + (energy / 255) * (sensitivity * 0.4);
            currentScale = currentScale + (targetScale - currentScale) * smoothingFactor;

            // 3. APPLY SHAKE TO DOM ELEMENTS
            logoContainer.style.transform = `translate(-50%, -50%) scale(${currentScale})`;
            
            // Subtle rotation for extra polish
            const rotation = (currentScale - 1) * 10; 
            bgLayer.style.transform = `scale(${1 + (currentScale-1)*0.2}) rotate(${rotation}deg)`;


            // 4. DRAW THE POLISHED SPECTRUM
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            // The radius should match the div size (300px / 2 = 150px) plus the shake
            const radius = 150 * currentScale; 

            ctx.beginPath();
            
            // Draw a full circle of bars
            for (let i = 0; i < bufferLength; i++) {
                // Get value and scale it
                let barHeight = dataArray[i] * 0.6;
                
                // If in Bass mode, we boost the visual height of bass bars to make them pop
                if (mode === 'bass' && i < 10) barHeight *= 1.5;

                const rads = (i * 2 * Math.PI) / bufferLength;

                // Calculation for outer point
                const x = centerX + Math.cos(rads) * (radius + barHeight);
                const y = centerY + Math.sin(rads) * (radius + barHeight);
                
                // Calculation for inner point (circle edge)
                const x_inner = centerX + Math.cos(rads) * (radius + 5); // +5 gap
                const y_inner = centerY + Math.sin(rads) * (radius + 5);

                // Draw Line
                ctx.moveTo(x_inner, y_inner);
                ctx.lineTo(x, y);
            }

            // STYLING THE BARS
            // Create a gradient for that "neon" look
            const gradient = ctx.createLinearGradient(centerX, centerY - radius, centerX, centerY + radius + 100);
            gradient.addColorStop(0, '#ff0055');
            gradient.addColorStop(1, '#5500ff');
            
            ctx.strokeStyle = gradient;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round'; // Rounds the ends of the bars
            
            // Add Glow
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#ff0055';
            
            ctx.stroke();
            
            // Reset glow for next frame (performance)
            ctx.shadowBlur = 0;
        }

        // Hide UI Hotkey
        document.addEventListener('keydown', (e) => {
            if(e.key.toLowerCase() === 'h') {
                const ui = document.getElementById('ui-controls');
                ui.style.opacity = ui.style.opacity === '0' ? '1' : '0';
            }
        });
        document.getElementById('toggle-ui').addEventListener('click', () => {
             const ui = document.getElementById('ui-controls');
             ui.style.opacity = '0';
        });

        // Resize handler
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

    </script>
</body>
</html>
