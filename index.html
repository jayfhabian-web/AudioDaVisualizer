<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Phonk V21 - Sub Only</title>
    <style>
        /* --- THEME --- */
        :root {
            --bg: #000;
            --panel: rgba(5, 5, 5, 0.95);
            --border: rgba(255, 255, 255, 0.1);
            --primary: #ff0033; 
            --text: #ddd;
        }

        body { margin: 0; background: var(--bg); font-family: 'Segoe UI', monospace; overflow: hidden; color: var(--text); }
        
        #flash-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; opacity: 0; mix-blend-mode: screen; }
        #canvas-layer { position: absolute; top: 0; left: 0; z-index: 1; }
        
        #logo-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 320px; height: 320px; z-index: 5; border-radius: 50%; 
            background-size: cover; background-position: center;
            box-shadow: 0 0 100px rgba(0,0,0,1);
            border: 2px solid rgba(255,255,255,0.05);
        }

        /* UI PANEL */
        #ui-panel {
            position: absolute; top: 0; left: 0; width: 300px; height: 100vh;
            background: var(--panel); border-right: 1px solid var(--border);
            padding: 20px; box-sizing: border-box; z-index: 20; overflow-y: auto;
            transition: transform 0.2s ease;
        }
        #ui-panel.hidden { transform: translateX(-100%); }

        h2 { font-size: 16px; color: #fff; margin: 0 0 20px 0; border-left: 3px solid var(--primary); padding-left: 10px; text-transform: uppercase; letter-spacing: 2px; }
        h3 { font-size: 10px; color: #555; margin-top: 20px; border-bottom: 1px solid #222; padding-bottom: 4px; font-weight: 700; text-transform: uppercase; }

        .control-group { margin-bottom: 14px; }
        label { display: flex; justify-content: space-between; font-size: 10px; color: #888; margin-bottom: 5px; font-weight: 600; text-transform: uppercase; }

        input[type="range"] { width: 100%; height: 4px; background: #222; border-radius: 2px; appearance: none; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 10px; height: 10px; background: #fff; border-radius: 50%; box-shadow: 0 0 5px rgba(255,255,255,0.5); }
        
        input[type="file"] { width: 100%; background: #111; border: 1px solid #222; color: #666; padding: 8px; border-radius: 4px; font-size: 10px; }
        input[type="color"] { width: 100%; height: 25px; border: none; background: none; cursor: pointer; padding: 0; }
        .checkbox-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; background: #0f0f0f; padding: 8px; border-radius: 4px; }

        /* LIVE MONITOR (SUB BASS ONLY) */
        .monitor-box {
            height: 30px; background: #000; border: 1px solid #222; border-radius: 3px; 
            display: flex; align-items: flex-end; padding: 1px; gap: 1px; position: relative;
        }
        .bar-slice { flex: 1; background: #333; transition: height 0.05s; }
        .bar-slice.active { background: var(--primary); box-shadow: 0 0 5px var(--primary); }
        #thresh-line { position: absolute; width: 100%; height: 1px; background: #fff; opacity: 0.6; bottom: 50%; pointer-events: none; }

        #toggle-ui { position: absolute; top: 15px; left: 320px; z-index: 25; background: #000; color: #fff; border: 1px solid #333; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-size: 9px; font-weight: bold; letter-spacing: 1px; }
        #ui-panel.hidden + #toggle-ui { left: 15px; }
    </style>
</head>
<body>

    <div id="flash-layer"></div>
    <canvas id="canvas-layer"></canvas>
    <div id="logo-container"></div>
    <button id="toggle-ui" onclick="toggleUI()">CONTROLS</button>

    <div id="ui-panel" id="panel">
        <h2>Phonk V21</h2>

        <div class="control-group">
            <label>Track</label>
            <input type="file" id="file-in" accept="audio/*">
            <audio id="audio" controls style="width:100%; margin-top:5px; height:20px; opacity:0.6;"></audio>
        </div>
        <div class="control-group">
            <label>Image</label>
            <input type="file" id="img-in" accept="image/*">
        </div>

        <h3>1. Sub-Bass Filter (Snare Killer)</h3>
        
        <div class="control-group">
            <label>Monitor (20Hz - 80Hz Only)</label>
            <div class="monitor-box" id="monitor">
                <div id="thresh-line"></div>
                <div class="bar-slice"></div><div class="bar-slice"></div>
                <div class="bar-slice"></div><div class="bar-slice"></div>
            </div>
            <div style="font-size:9px; color:#444; margin-top:4px;">If these bars jump, it's KICK only.</div>
        </div>

        <div class="control-group">
            <label>Trigger Threshold</label>
            <input type="range" id="thresh" min="0" max="255" value="160" oninput="updThresh(this.value)">
        </div>
        <div class="control-group">
            <label>Punch Strength</label>
            <input type="range" id="sens" min="1.0" max="4.0" step="0.1" value="2.0">
        </div>

        <h3>2. Blended Visuals</h3>
        <div class="checkbox-row">
            <input type="checkbox" id="auto-color" checked onchange="toggleAutoColor()">
            <span style="font-size:10px;">Auto Colors</span>
        </div>
        <div id="manual-colors" style="display:none; margin-bottom:10px;">
            <div style="display:flex; gap:5px;">
                <div style="flex:1"><label>Bass</label><input type="color" id="col-bass" value="#ff0033"></div>
                <div style="flex:1"><label>Highs</label><input type="color" id="col-audio" value="#ffffff"></div>
            </div>
        </div>

        <div class="control-group">
            <label>Bar Width</label>
            <input type="range" id="bar-width" min="2" max="60" value="25">
        </div>
        <div class="control-group">
            <label>Bar Length</label>
            <input type="range" id="bar-len" min="50" max="300" value="140">
        </div>
        <div class="control-group">
            <label>Circle Radius</label>
            <input type="range" id="radius" min="100" max="350" value="170">
        </div>

        <h3>3. Effects</h3>
        <div class="checkbox-row" style="flex-wrap:wrap;">
            <label style="margin-right:10px;"><input type="checkbox" id="fx-zoom" checked> Zoom</label>
            <label style="margin-right:10px;"><input type="checkbox" id="fx-shake" checked> Shake</label>
            <label><input type="checkbox" id="fx-flash" checked> Flash</label>
        </div>
    </div>

    <script>
        const dom = {
            audio: document.getElementById('audio'),
            canvas: document.getElementById('canvas-layer'),
            ctx: document.getElementById('canvas-layer').getContext('2d'),
            logo: document.getElementById('logo-container'),
            flash: document.getElementById('flash-layer'),
            panel: document.getElementById('ui-panel'),
            monitor: document.querySelectorAll('.bar-slice'),
            tLine: document.getElementById('thresh-line'),
            colBass: document.getElementById('col-bass'),
            colAudio: document.getElementById('col-audio'),
            autoColor: document.getElementById('auto-color')
        };
        dom.canvas.width = window.innerWidth;
        dom.canvas.height = window.innerHeight;

        const state = {
            connected: false,
            physics: 0,
            extracted: { bass: '#ff0033', audio: '#ffffff' }
        };

        let audioCtx, source, analyser;

        dom.audio.addEventListener('play', () => {
            if(state.connected) { if(audioCtx.state === 'suspended') audioCtx.resume(); return; }
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            source = audioCtx.createMediaElementSource(dom.audio);
            analyser = audioCtx.createAnalyser();
            
            // High Res for precision
            analyser.fftSize = 2048; 
            
            source.connect(analyser);
            source.connect(audioCtx.destination); 
            state.connected = true;
            loop();
        });

        function loop() {
            requestAnimationFrame(loop);
            const buffer = analyser.frequencyBinCount; 
            const data = new Uint8Array(buffer);
            analyser.getByteFrequencyData(data);

            // --- 1. STRICT SUB-BASS TRIGGER ---
            // Only look at Bins 1, 2, 3, 4 (approx 20Hz - 85Hz).
            // This is "below" the snare frequency.
            let subEnergy = 0;
            let monitorVals = [];
            
            for(let i=1; i<=4; i++) {
                subEnergy += data[i];
                monitorVals.push(data[i]);
            }
            subEnergy /= 4; // Average

            // Update Monitor UI
            const thresh = parseInt(document.getElementById('thresh').value);
            monitorVals.forEach((val, idx) => {
                if(dom.monitor[idx]) {
                    dom.monitor[idx].style.height = (val / 255 * 100) + "%";
                    dom.monitor[idx].className = (val > thresh) ? 'bar-slice active' : 'bar-slice';
                }
            });

            // Trigger Logic
            const sens = parseFloat(document.getElementById('sens').value);
            let force = 0;
            if (subEnergy > thresh) {
                let overflow = subEnergy - thresh;
                force = (overflow / (255 - thresh)) * sens;
            }

            // Physics Smoothing
            if(force > state.physics) state.physics = force;
            else state.physics *= 0.85; // Snappy decay
            
            // Safety Clamp
            if(state.physics > 2.0) state.physics = 2.0;
            if(state.physics < 0.001) state.physics = 0;

            draw(data, buffer, state.physics);
            applyFx(state.physics);
        }

        // --- 2. BLENDED VISUALS (SYMMETRICAL) ---
        function draw(data, count, phys) {
            const ctx = dom.ctx;
            const cx = dom.canvas.width / 2;
            const cy = dom.canvas.height / 2;
            const baseRad = parseInt(document.getElementById('radius').value);
            const maxLen = parseInt(document.getElementById('bar-len').value);
            
            // Physics affects the WHOLE circle radius, keeping it unified
            const rad = baseRad + (phys * 15);
            
            const w = parseFloat(document.getElementById('bar-width').value);
            
            // Colors
            const cBass = hexToRgb(dom.colBass.value);
            const cAudio = hexToRgb(dom.colAudio.value);

            ctx.clearRect(0, 0, dom.canvas.width, dom.canvas.height);

            // We draw 60 bars total, covering frequencies 0Hz - 1000Hz (The meat of the song)
            // We use Mirrored drawing: 0 is top, 30 is bottom.
            const totalBars = 60;
            const angleStep = Math.PI / totalBars; // Half circle step (we mirror it)

            for(let i = 0; i < totalBars; i++) {
                // Get data. We skip 2 bins to spread out the look.
                let val = data[i * 2]; 
                
                // Height Calculation
                let h = (val / 255) * maxLen;
                if(h < 5) h = 5; // Min height

                // --- COLOR BLENDING ---
                // Interpolate based on position (i)
                // i=0 (Bass) -> 100% Bass Color
                // i=60 (Highs) -> 100% Audio Color
                let mix = i / 25; // Fade out quickly (first 25 bars are gradient)
                if(mix > 1) mix = 1;

                const r = cBass.r + (cAudio.r - cBass.r) * mix;
                const g = cBass.g + (cAudio.g - cBass.g) * mix;
                const b = cBass.b + (cAudio.b - cBass.b) * mix;
                ctx.fillStyle = `rgb(${r},${g},${b})`;

                // --- MIRRORED DRAWING ---
                // Right Side
                ctx.save();
                ctx.translate(cx, cy);
                ctx.rotate( (i * angleStep) - (Math.PI/2) ); // Start at top -90deg
                ctx.fillRect(rad, -w/2, h, w); // Draw outwards
                ctx.restore();

                // Left Side (Mirror)
                ctx.save();
                ctx.translate(cx, cy);
                ctx.rotate( -(i * angleStep) - (Math.PI/2) ); // Rotate opposite way
                ctx.fillRect(rad, -w/2, h, w);
                ctx.restore();
            }
        }

        function applyFx(p) {
            const mag = 1.0; 
            let s=1, x=0, y=0, f=0;

            if (p > 0.01) {
                if(document.getElementById('fx-zoom').checked) s += (p * 0.2);
                if(document.getElementById('fx-shake').checked) {
                    const shake = p * 15; 
                    x = (Math.random()-0.5) * shake;
                    y = (Math.random()-0.5) * shake;
                }
                if(document.getElementById('fx-flash').checked) f = p * 0.3;
            }

            dom.logo.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px)) scale(${s})`;
            dom.flash.style.opacity = f;
            dom.flash.style.background = 'white';
        }

        // --- UTILS ---
        function hexToRgb(hex) {
            const bigint = parseInt(hex.replace('#',''), 16);
            return { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255 };
        }
        window.updThresh = (v) => { dom.tLine.style.bottom = (v/255*100) + "%"; };
        window.toggleUI = () => dom.panel.classList.toggle('hidden');
        window.toggleAutoColor = () => {
            const a = dom.autoColor.checked;
            document.getElementById('manual-colors').style.display = a ? 'none' : 'block';
            if(a) { dom.colBass.value = state.extracted.bass; dom.colAudio.value = state.extracted.audio; }
        }

        document.getElementById('img-in').addEventListener('change', e => {
            const u = URL.createObjectURL(e.target.files[0]);
            dom.logo.style.backgroundImage = `url(${u})`;
            const i = new Image(); i.src = u;
            i.onload = () => {
                const c = document.createElement('canvas'); const x = c.getContext('2d');
                c.width=i.width; c.height=i.height; x.drawImage(i,0,0);
                const p1 = x.getImageData(i.width/2, i.height/2, 1, 1).data;
                const p2 = x.getImageData(10, 10, 1, 1).data;
                state.extracted.bass = "#" + ((1<<24)+(p1[0]<<16)+(p1[1]<<8)+p1[2]).toString(16).slice(1);
                state.extracted.audio = "#" + ((1<<24)+(p2[0]<<16)+(p2[1]<<8)+p2[2]).toString(16).slice(1);
                if(dom.autoColor.checked) { dom.colBass.value = state.extracted.bass; dom.colAudio.value = state.extracted.audio; }
            }
        });
        document.getElementById('file-in').addEventListener('change', e => { dom.audio.src = URL.createObjectURL(e.target.files[0]); dom.audio.play(); });
        window.onresize = () => { dom.canvas.width=window.innerWidth; dom.canvas.height=window.innerHeight; }
    </script>
</body>
</html>
