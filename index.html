<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Phonk Engine V12 - Specterr Style</title>
    <style>
        /* --- THEME --- */
        :root {
            --bg: #050505;
            --panel: rgba(15, 15, 15, 0.95);
            --border: rgba(255, 255, 255, 0.1);
            --primary: #ff0055;
            --text: #e0e0e0;
        }

        body { margin: 0; background: var(--bg); font-family: 'Segoe UI', sans-serif; overflow: hidden; color: var(--text); }
        
        /* VISUAL LAYERS */
        #flash-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; opacity: 0; mix-blend-mode: overlay; }
        #canvas-layer { position: absolute; top: 0; left: 0; z-index: 1; }
        
        #logo-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; height: 300px; z-index: 5; border-radius: 50%; 
            background-size: cover; background-position: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* UI PANEL */
        #ui-panel {
            position: absolute; top: 0; left: 0; width: 340px; height: 100vh;
            background: var(--panel); border-right: 1px solid var(--border);
            padding: 20px; box-sizing: border-box; z-index: 20; overflow-y: auto;
            transition: transform 0.3s ease; backdrop-filter: blur(10px);
        }
        #ui-panel.hidden { transform: translateX(-100%); }

        h2 { font-size: 16px; margin: 0 0 20px 0; border-bottom: 2px solid var(--primary); display: inline-block; padding-bottom: 5px; color: #fff; }
        h3 { font-size: 11px; text-transform: uppercase; color: #666; margin-top: 25px; border-bottom: 1px solid #222; padding-bottom: 5px; }

        .control-group { margin-bottom: 12px; }
        label { display: flex; justify-content: space-between; font-size: 11px; color: #bbb; margin-bottom: 6px; font-weight: 600; }

        /* INPUTS */
        input[type="range"] { width: 100%; height: 4px; background: #333; border-radius: 2px; appearance: none; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 12px; height: 12px; background: white; border-radius: 50%; box-shadow: 0 0 4px rgba(255,255,255,0.5); }
        
        input[type="file"] { width: 100%; background: #222; border: 1px solid #333; color: #888; padding: 6px; border-radius: 4px; font-size: 11px; }
        input[type="color"] { width: 100%; height: 30px; border: none; background: none; cursor: pointer; padding: 0; }
        
        .checkbox-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; background: #222; padding: 8px; border-radius: 4px; border: 1px solid #333; }
        
        /* BASS METER */
        .meter-box { height: 6px; background: #111; border-radius: 3px; position: relative; overflow: hidden; margin-top: 5px; border: 1px solid #333; }
        .meter-fill { height: 100%; width: 0%; background: #00ff00; transition: width 0.05s linear; }
        .meter-line { position: absolute; top: 0; bottom: 0; width: 2px; background: red; z-index: 2; }

        /* FX CARDS */
        .fx-card { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 5px; margin-bottom: 8px; border: 1px solid #333; }
        .fx-head { display: flex; justify-content: space-between; font-size: 10px; font-weight: bold; margin-bottom: 5px; color: #fff; }
        .btn-add { width: 100%; background: transparent; border: 1px dashed #444; color: #888; padding: 8px; cursor: pointer; font-size: 10px; margin-top: 5px; }
        .btn-add:hover { border-color: var(--primary); color: white; }

        /* TOGGLE BUTTON */
        #toggle-ui { position: absolute; top: 20px; left: 360px; z-index: 25; background: #111; color: white; border: 1px solid #444; padding: 8px 16px; cursor: pointer; border-radius: 20px; font-size: 11px; transition: left 0.3s; }
        #ui-panel.hidden + #toggle-ui { left: 20px; }
    </style>
</head>
<body>

    <div id="flash-layer"></div>
    <canvas id="canvas-layer"></canvas>
    <div id="logo-container"></div>
    <button id="toggle-ui" onclick="toggleUI()">Hide Controls</button>

    <div id="ui-panel" id="panel">
        <h2>PHONK ENGINE V12</h2>

        <div class="control-group">
            <label>Audio</label>
            <input type="file" id="file-in" accept="audio/*">
            <audio id="audio" controls style="width:100%; margin-top:5px; height:25px; opacity:0.6;"></audio>
        </div>
        <div class="control-group">
            <label>Image</label>
            <input type="file" id="img-in" accept="image/*">
        </div>

        <h3>Colors</h3>
        <div class="checkbox-row">
            <input type="checkbox" id="auto-color" checked onchange="toggleAutoColor()">
            <span style="font-size:11px;color:#ccc;font-weight:bold;">Auto-Extract Colors</span>
        </div>
        <div class="control-group" id="manual-colors" style="display:none; opacity: 0.5;">
            <div style="display: flex; gap: 10px;">
                <div style="flex:1"><label>Bass Color</label><input type="color" id="col-bass" value="#ff0055"></div>
                <div style="flex:1"><label>Melody Color</label><input type="color" id="col-audio" value="#ffffff"></div>
            </div>
        </div>

        <h3>Reactivity & Sensitivity</h3>
        
        <div class="control-group">
            <label style="color:var(--primary);">Bass Sensitivity (Boost Logic)</label>
            <input type="range" id="bass-sens" min="1" max="3" step="0.1" value="1.5" oninput="upd('v-sens', this.value)">
            <label style="font-weight:normal; margin-top:2px;">Multiplier: <span id="v-sens">1.5</span>x</label>
        </div>

        <div class="control-group">
            <label>Bass Threshold (Gate)</label>
            <div class="meter-box">
                <div id="thresh-line" class="meter-line" style="left:50%"></div>
                <div id="meter-fill" class="meter-fill"></div>
            </div>
            <input type="range" id="thresh" min="0" max="255" value="130" oninput="updThresh(this.value)" style="margin-top:5px;">
        </div>

        <h3>Specterr Style</h3>
        <div class="control-group">
            <label>Bass/Melody Split Point <span id="v-split">4</span></label>
            <input type="range" id="bass-split" min="1" max="20" value="5" oninput="upd('v-split', this.value)">
        </div>
        <div class="control-group">
            <label>Bass Bar Pop (Height Boost)</label>
            <input type="range" id="bass-pop" min="1" max="4" step="0.1" value="1.5">
        </div>
        <div class="control-group">
            <label>Total Bar Height</label>
            <input type="range" id="global-scale" min="0.5" max="2" step="0.1" value="1.0">
        </div>

        <h3>Effects</h3>
        <div id="stack"></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <button class="btn-add" onclick="addFx('zoom')">+ Zoom</button>
            <button class="btn-add" onclick="addFx('rotate')">+ Rotate</button>
            <button class="btn-add" onclick="addFx('exposure')">+ Flash</button>
            <button class="btn-add" onclick="addFx('shake')">+ Shake</button>
        </div>
    </div>

    <script>
        // --- SETUP ---
        const dom = {
            audio: document.getElementById('audio'),
            canvas: document.getElementById('canvas-layer'),
            ctx: document.getElementById('canvas-layer').getContext('2d'),
            logo: document.getElementById('logo-container'),
            flash: document.getElementById('flash-layer'),
            meter: document.getElementById('meter-fill'),
            tLine: document.getElementById('thresh-line'),
            panel: document.getElementById('ui-panel'),
            colBass: document.getElementById('col-bass'),
            colAudio: document.getElementById('col-audio'),
            autoColorCheck: document.getElementById('auto-color')
        };
        dom.canvas.width = window.innerWidth;
        dom.canvas.height = window.innerHeight;

        const state = {
            effects: [{ id: 1, type: 'zoom', intensity: 0.4 }],
            bassVal: 0,
            fftSize: 256,
            connected: false,
            extractedColors: { bass: '#ff0055', audio: '#ffffff' }
        };

        let audioCtx, source, analyser;

        // --- 1. AUDIO GRAPH (Full Spectrum) ---
        dom.audio.addEventListener('play', () => {
            if(state.connected) { if(audioCtx.state === 'suspended') audioCtx.resume(); return; }
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                source = audioCtx.createMediaElementSource(dom.audio);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = state.fftSize;

                // Direct Connection: No hardware filters.
                // We want to SEE the melody, even if we don't ZOOM to it.
                source.connect(analyser);
                analyser.connect(audioCtx.destination);

                state.connected = true;
                loop();
            } catch(e) { console.error(e); }
        });

        // --- 2. RENDER LOOP ---
        function loop() {
            requestAnimationFrame(loop);
            const buffer = analyser.frequencyBinCount;
            const data = new Uint8Array(buffer);
            analyser.getByteFrequencyData(data);

            // A. CALCULATE BASS PHYSICS (Internal Logic)
            // We manually look at indices 0-4 (Low Freqs)
            let rawBass = (data[0] + data[1] + data[2] + data[3]) / 4;
            
            // Apply User Sensitivity (Multiplier)
            const sensitivity = parseFloat(document.getElementById('bass-sens').value);
            rawBass = Math.min(255, rawBass * sensitivity);

            // Update UI Meter
            dom.meter.style.width = (rawBass / 255 * 100) + "%";

            // Threshold Logic
            const thresh = parseInt(document.getElementById('thresh').value);
            let active = 0;
            if(rawBass > thresh) active = (rawBass - thresh) / (255 - thresh);

            // Decay (Smoothing)
            if(active > state.bassVal) state.bassVal = active; 
            else state.bassVal *= 0.85; // Fixed decay for snappy feel

            // B. APPLY EFFECTS
            applyFx(state.bassVal);

            // C. DRAW BARS (Full Spectrum)
            draw(data, buffer, state.bassVal);
        }

        function draw(data, count, bassPhysics) {
            const ctx = dom.ctx;
            const cx = dom.canvas.width / 2;
            const cy = dom.canvas.height / 2;
            const rad = 150 + (bassPhysics * 40); // Circle grows with bass

            const colBass = dom.colBass.value;
            const colAudio = dom.colAudio.value;
            const splitIndex = parseInt(document.getElementById('bass-split').value);
            const pop = parseFloat(document.getElementById('bass-pop').value);
            const globalScale = parseFloat(document.getElementById('global-scale').value);

            ctx.clearRect(0, 0, dom.canvas.width, dom.canvas.height);
            ctx.lineWidth = (600 / count);
            ctx.lineCap = 'round';

            // Loop through ALL frequencies (Bass + Melody)
            for(let i = 0; i < count; i++) {
                let val = data[i];
                let h = val * 0.8 * globalScale; 

                // Styling Logic
                const isBassBar = i < splitIndex;

                if (isBassBar) {
                    ctx.strokeStyle = colBass;
                    // Apply "Pop" to bass bars using the physics value
                    h *= (1 + (bassPhysics * (pop - 1)));
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = colBass;
                } else {
                    ctx.strokeStyle = colAudio;
                    ctx.shadowBlur = 0;
                }

                const ang = (i * 2 * Math.PI) / count - (Math.PI/2);
                
                // Draw
                const x0 = cx + Math.cos(ang) * (rad + 5);
                const y0 = cy + Math.sin(ang) * (rad + 5);
                const x1 = cx + Math.cos(ang) * (rad + 5 + h);
                const y1 = cy + Math.sin(ang) * (rad + 5 + h);

                ctx.beginPath(); 
                ctx.moveTo(x0, y0); 
                ctx.lineTo(x1, y1); 
                ctx.stroke();
            }
        }

        // --- 3. EFFECTS ---
        function applyFx(b) {
            let s=1, r=0, x=0, y=0, e=0;
            state.effects.forEach(f => {
                const v = f.intensity * b;
                if(f.type==='zoom') s+=v;
                if(f.type==='rotate') r+=v*30;
                if(f.type==='exposure') e+=v;
                if(f.type==='shake') { x+=(Math.random()-0.5)*v*40; y+=(Math.random()-0.5)*v*40; }
            });
            dom.logo.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px)) scale(${Math.max(0,s)}) rotate(${r}deg)`;
            dom.flash.style.opacity = Math.min(1, Math.abs(e));
            dom.flash.style.background = e > 0 ? 'white' : 'black';
        }

        // --- 4. UTILS & COLORS ---
        function extractColorsFromImage(imgElement) {
            const c = document.createElement('canvas'); const x = c.getContext('2d');
            c.width = imgElement.width; c.height = imgElement.height;
            x.drawImage(imgElement, 0, 0, c.width, c.height);
            // Center (Bass)
            const p1 = x.getImageData(c.width/2, c.height/2, 1, 1).data;
            // Top Left (Melody)
            const p2 = x.getImageData(10, 10, 1, 1).data;
            
            state.extractedColors.bass = rgbToHex(p1[0], p1[1], p1[2]);
            state.extractedColors.audio = rgbToHex(p2[0], p2[1], p2[2]);
            
            if(dom.autoColorCheck.checked) { 
                dom.colBass.value = state.extractedColors.bass; 
                dom.colAudio.value = state.extractedColors.audio; 
            }
        }
        function rgbToHex(r, g, b) { return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1); }
        window.toggleAutoColor = () => {
            const isAuto = dom.autoColorCheck.checked;
            document.getElementById('manual-colors').style.display = isAuto ? 'none' : 'block';
            if(isAuto) { dom.colBass.value = state.extractedColors.bass; dom.colAudio.value = state.extractedColors.audio; }
        }

        // General UI
        window.upd = (id, v) => document.getElementById(id).innerText = v;
        window.updThresh = (v) => { upd('thresh', v); dom.tLine.style.left = (v/255*100) + '%'; }
        window.toggleUI = () => dom.panel.classList.toggle('hidden');
        
        document.getElementById('file-in').addEventListener('change', e => { dom.audio.src = URL.createObjectURL(e.target.files[0]); dom.audio.play(); });
        document.getElementById('img-in').addEventListener('change', e => {
            const url = URL.createObjectURL(e.target.files[0]);
            dom.logo.style.backgroundImage = `url(${url})`;
            const img = new Image(); img.src = url; img.onload = () => extractColorsFromImage(img);
        });
        
        // Stack
        function renderStack() {
            const el = document.getElementById('stack'); el.innerHTML = '';
            state.effects.forEach(f => {
                el.innerHTML += `<div class="fx-card"><div class="fx-head">${f.type.toUpperCase()} <span style="cursor:pointer;color:#555" onclick="remFx(${f.id})">Ã—</span></div><input type="range" min="-2" max="2" step="0.1" value="${f.intensity}" oninput="updFx(${f.id}, this.value)"></div>`;
            });
        }
        window.addFx = t => { state.effects.push({id:Date.now(), type:t, intensity:0.5}); renderStack(); }
        window.remFx = i => { state.effects = state.effects.filter(e=>e.id!==i); renderStack(); }
        window.updFx = (i,v) => { state.effects.find(e=>e.id===i).intensity = parseFloat(v); }
        renderStack();
        window.onresize = () => { dom.canvas.width=window.innerWidth; dom.canvas.height=window.innerHeight; }
    </script>
</body>
</html>
