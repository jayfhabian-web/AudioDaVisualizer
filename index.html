<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Phonk Engine V6 - Debug Mode</title>
    <style>
        body { margin: 0; background: #111; font-family: monospace; color: white; overflow: hidden; }
        
        /* LAYERS */
        #flash-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 20; pointer-events: none; opacity: 0;
            background: white; /* Default to white flash */
        }
        
        #canvas-layer { position: absolute; top: 0; left: 0; z-index: 1; }
        
        #logo-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; height: 300px; z-index: 5;
            background: red; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        }
        
        /* CONTROLS */
        #ui {
            position: absolute; top: 0; left: 0; width: 350px; height: 100%;
            background: #222; z-index: 30; padding: 20px; box-sizing: border-box;
            border-right: 2px solid #444; overflow-y: auto;
        }
        
        .debug-bar-container {
            width: 100%; height: 20px; background: #000; margin-bottom: 20px; position: relative; border: 1px solid #555;
        }
        #debug-bar { width: 0%; height: 100%; background: lime; transition: width 0.05s linear; }
        #threshold-line {
            position: absolute; top: 0; bottom: 0; width: 2px; background: red; z-index: 2;
        }

        button { padding: 10px; width: 100%; margin-bottom: 10px; cursor: pointer; font-weight: bold; }
        .start-btn { background: lime; border: none; font-size: 16px; }
        
        .effect-row { background: #333; padding: 10px; margin-bottom: 5px; border-left: 4px solid orange; }
        input[type="range"] { width: 100%; }
        label { display: block; margin-bottom: 5px; color: #ccc; }
    </style>
</head>
<body>

    <div id="flash-layer"></div>
    <canvas id="canvas-layer"></canvas>
    <div id="logo-container">LOGO</div>

    <div id="ui">
        <h2>V6 DEBUGGER</h2>
        
        <label>1. Load Song</label>
        <input type="file" id="audio-file" accept="audio/*">
        
        <label>2. START ENGINE (Required)</label>
        <button class="start-btn" onclick="startAudioContext()">CLICK TO START</button>

        <hr style="border-color:#444">

        <label>BASS METER (Must cross Red Line)</label>
        <div class="debug-bar-container">
            <div id="threshold-line" style="left: 50%;"></div> <div id="debug-bar"></div>
        </div>
        
        <label>Threshold Level: <span id="thresh-val">128</span></label>
        <input type="range" id="threshold" min="0" max="255" value="128" oninput="updateThreshold(this.value)">

        <hr style="border-color:#444">

        <h3>Effects Stack</h3>
        <button onclick="addEffect('zoom')">+ Add Zoom</button>
        <button onclick="addEffect('rotate')">+ Add Rotate</button>
        <button onclick="addEffect('flash')">+ Add Flash</button>
        
        <div id="effect-list"></div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        const state = {
            ctx: null,
            analyser: null,
            source: null,
            isPlaying: false,
            effects: [],
            bassVal: 0 // 0 to 255
        };

        const canvas = document.getElementById('canvas-layer');
        const drawCtx = canvas.getContext('2d');
        const logo = document.getElementById('logo-container');
        const flash = document.getElementById('flash-layer');
        const debugBar = document.getElementById('debug-bar');
        const threshLine = document.getElementById('threshold-line');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // --- 1. AUDIO SYSTEM ---
        
        // Browser Policy Fix: User must click a button to initialize AudioContext
        async function startAudioContext() {
            if (!state.ctx) {
                state.ctx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (state.ctx.state === 'suspended') {
                await state.ctx.resume();
            }
            alert("Audio Engine Active. Now upload a song.");
        }

        document.getElementById('audio-file').addEventListener('change', function(e) {
            if (!state.ctx) {
                alert("Please click 'CLICK TO START' first!");
                return;
            }
            
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(ev) {
                state.ctx.decodeAudioData(ev.target.result, function(buffer) {
                    if (state.source) state.source.disconnect();
                    
                    state.source = state.ctx.createBufferSource();
                    state.source.buffer = buffer;
                    
                    state.analyser = state.ctx.createAnalyser();
                    state.analyser.fftSize = 256;
                    
                    state.source.connect(state.analyser);
                    state.analyser.connect(state.ctx.destination);
                    
                    state.source.start(0);
                    state.isPlaying = true;
                    loop();
                });
            };
            reader.readAsArrayBuffer(file);
        });

        // --- 2. THRESHOLD LOGIC ---
        function updateThreshold(val) {
            document.getElementById('thresh-val').innerText = val;
            // Move red line visually
            const percent = (val / 255) * 100;
            threshLine.style.left = percent + "%";
        }

        // --- 3. THE LOOP ---
        function loop() {
            if (!state.isPlaying) return;
            requestAnimationFrame(loop);

            const bufferLength = state.analyser.frequencyBinCount;
            const data = new Uint8Array(bufferLength);
            state.analyser.getByteFrequencyData(data);

            // A. CALCULATE BASS
            // Simple average of first 5 bars (Deep Bass)
            let rawBass = 0;
            for(let i=0; i<5; i++) rawBass += data[i];
            rawBass = rawBass / 5;

            // B. UPDATE DEBUG METER
            // Show raw bass on the green bar
            const bassPercent = (rawBass / 255) * 100;
            debugBar.style.width = bassPercent + "%";

            // C. GATE LOGIC
            const thresh = parseInt(document.getElementById('threshold').value);
            let activeBass = 0; // This is the value sent to effects

            // If Green Bar crosses Red Line
            if (rawBass > thresh) {
                // Normalize 0.0 to 1.0 based on how much it crossed
                activeBass = (rawBass - thresh) / (255 - thresh); 
                // Cap at 1.0
                if (activeBass > 1) activeBass = 1;
            } else {
                activeBass = 0;
            }

            // D. APPLY EFFECTS
            applyEffects(activeBass);

            // E. DRAW SIMPLE SPECTRUM (Visual Confirm)
            drawCtx.clearRect(0, 0, canvas.width, canvas.height);
            drawCtx.fillStyle = 'white';
            const barWidth = (canvas.width / bufferLength) * 2.5;
            for(let i = 0; i < bufferLength; i++) {
                const barHeight = data[i];
                drawCtx.fillRect(i * barWidth, canvas.height - barHeight, barWidth - 1, barHeight);
            }
        }

        // --- 4. EFFECTS LOGIC ---
        function applyEffects(bassPower) {
            // Default transforms
            let scale = 1;
            let rotate = 0;
            let flashOpacity = 0;

            state.effects.forEach(eff => {
                const impact = parseFloat(eff.intensity) * bassPower;

                if (eff.type === 'zoom') {
                    scale += impact; 
                } 
                else if (eff.type === 'rotate') {
                    rotate += impact * 45; // 45 degrees per 1.0 intensity
                }
                else if (eff.type === 'flash') {
                    flashOpacity += impact;
                }
            });

            // APPLY TO DOM
            logo.style.transform = `translate(-50%, -50%) scale(${scale}) rotate(${rotate}deg)`;
            
            // Fix Flash limits
            if (flashOpacity > 1) flashOpacity = 1;
            if (flashOpacity < 0) flashOpacity = 0;
            flash.style.opacity = flashOpacity;
        }

        // --- 5. UI HELPERS ---
        window.addEffect = (type) => {
            const id = Date.now();
            state.effects.push({ id, type, intensity: 0.5 });
            renderEffectList();
        }

        window.removeEffect = (id) => {
            state.effects = state.effects.filter(e => e.id !== id);
            renderEffectList();
        }

        window.updateEffectIntensity = (id, val) => {
            const effect = state.effects.find(e => e.id === id);
            if (effect) effect.intensity = val;
        }

        function renderEffectList() {
            const container = document.getElementById('effect-list');
            container.innerHTML = '';
            state.effects.forEach(eff => {
                container.innerHTML += `
                    <div class="effect-row">
                        <strong>${eff.type.toUpperCase()}</strong> 
                        <button onclick="removeEffect(${eff.id})" style="width:auto; float:right; padding:2px 5px;">X</button>
                        <br>
                        <label>Intensity: ${eff.intensity}</label>
                        <input type="range" min="-2" max="2" step="0.1" value="${eff.intensity}" 
                        oninput="updateEffectIntensity(${eff.id}, this.value)">
                    </div>
                `;
            });
        }
    </script>
</body>
</html>
