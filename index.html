<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PhonkVisualizer V4 - Custom Colors</title>
    <style>
        /* --- STYLING --- */
        body { margin: 0; background: #050505; font-family: 'Segoe UI', sans-serif; overflow: hidden; color: white; }
        
        #canvas-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        #bg-layer {
            position: absolute; top: -10%; left: -10%; width: 120%; height: 120%; z-index: 0;
            background-size: cover; background-position: center;
            filter: blur(12px) brightness(0.3);
            transition: transform 0.05s linear;
        }

        #logo-container {
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            z-index: 2; width: 300px; height: 300px;
            display: flex; justify-content: center; align-items: center;
        }

        #logo {
            width: 100%; height: 100%; border-radius: 50%; 
            background-size: cover; background-position: center;
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.1);
        }

        /* --- CONTROLS UI --- */
        #ui-controls {
            position: absolute; top: 20px; left: 20px; z-index: 10;
            background: rgba(10, 10, 10, 0.9); 
            backdrop-filter: blur(10px);
            padding: 20px; border-radius: 8px; border: 1px solid #333;
            width: 260px; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 10px 40px black;
        }
        
        h3 { margin: 0 0 15px 0; color: #fff; border-bottom: 1px solid #333; padding-bottom: 10px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 11px; color: #aaa; margin-bottom: 5px; font-weight: bold; }
        
        input[type="range"] { width: 100%; cursor: pointer; accent-color: #ff0055; }
        input[type="color"] { width: 100%; height: 35px; border: none; background: none; cursor: pointer; }
        input[type="file"] { font-size: 11px; color: #888; }

        /* The "Mode" toggle */
        .toggle-row { display: flex; gap: 10px; background: #222; padding: 2px; border-radius: 4px; }
        .toggle-btn { flex: 1; background: none; border: none; color: #666; padding: 6px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .toggle-btn.active { background: #444; color: white; border-radius: 3px; }

        #hide-hint { position: absolute; bottom: 10px; left: 20px; color: #444; font-size: 10px; z-index: 10; }
    </style>
</head>
<body>

    <div id="bg-layer"></div>
    <canvas id="canvas-layer"></canvas>

    <div id="logo-container">
        <div id="logo" style="background-image: url('https://via.placeholder.com/300');"></div>
    </div>

    <div id="ui-controls">
        <h3>1. Audio & Files</h3>
        <div class="control-group">
            <label>Song File</label>
            <input type="file" id="audio-input" accept="audio/*">
        </div>
        <div class="control-group">
            <label>Center Image</label>
            <input type="file" id="logo-input" accept="image/*">
        </div>
        <div class="control-group">
            <label>Background Image</label>
            <input type="file" id="bg-input" accept="image/*">
        </div>

        <h3>2. Behavior</h3>
        <div class="control-group">
            <label>Reaction Mode</label>
            <div class="toggle-row">
                <button class="toggle-btn active" onclick="setMode('bass', this)">KICK ONLY</button>
                <button class="toggle-btn" onclick="setMode('all', this)">FULL AUDIO</button>
            </div>
        </div>
        <div class="control-group">
            <label>Bass Threshold (The "Gate")</label>
            <input type="range" id="threshold" min="0" max="200" value="160">
        </div>
        <div class="control-group">
            <label>Shake Intensity</label>
            <input type="range" id="intensity" min="0" max="3" step="0.1" value="1.5">
        </div>

        <h3>3. Colors</h3>
        <div class="control-group" style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label>Inner Color</label>
                <input type="color" id="color-start" value="#ff0055">
            </div>
            <div style="flex: 1;">
                <label>Outer Color</label>
                <input type="color" id="color-end" value="#5500ff">
            </div>
        </div>
    </div>

    <div id="hide-hint">Press 'H' to hide controls</div>

    <script>
        // --- SETUP ---
        const canvas = document.getElementById('canvas-layer');
        const ctx = canvas.getContext('2d');
        const bgLayer = document.getElementById('bg-layer');
        const logoContainer = document.getElementById('logo-container');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let audioCtx, audioSrc, analyser;
        let isPlaying = false;
        let currentMode = 'bass';
        
        // Smoothing Variables
        let currentScale = 1;
        let targetScale = 1;
        const smoothingFactor = 0.2; // How fast it snaps to the beat

        // --- AUDIO INPUT ---
        document.getElementById('audio-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;

            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            const reader = new FileReader();
            reader.onload = function(ev) {
                audioCtx.decodeAudioData(ev.target.result, function(buffer) {
                    if(audioSrc) audioSrc.disconnect();
                    audioSrc = audioCtx.createBufferSource();
                    audioSrc.buffer = buffer;

                    analyser = audioCtx.createAnalyser();
                    analyser.fftSize = 256; 
                    // Lower smoothing makes it react faster to kicks
                    analyser.smoothingTimeConstant = 0.6; 

                    audioSrc.connect(analyser);
                    analyser.connect(audioCtx.destination);
                    audioSrc.start(0);
                    isPlaying = true;
                    render();
                });
            };
            reader.readAsArrayBuffer(file);
        });

        // --- IMAGE HANDLING ---
        document.getElementById('logo-input').addEventListener('change', (e) => {
            const url = URL.createObjectURL(e.target.files[0]);
            document.getElementById('logo').style.backgroundImage = `url(${url})`;
        });
        document.getElementById('bg-input').addEventListener('change', (e) => {
            const url = URL.createObjectURL(e.target.files[0]);
            bgLayer.style.backgroundImage = `url(${url})`;
            document.getElementById('logo').style.backgroundImage = `url(${url})`; 
        });

        // --- MODE TOGGLE ---
        window.setMode = (mode, btn) => {
            currentMode = mode;
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // --- RENDER LOOP ---
        function render() {
            if(!isPlaying) return;
            requestAnimationFrame(render);

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 1. CALCULATE ENERGY
            let energy = 0;
            
            // "KICK ONLY" MODE
            if (currentMode === 'bass') {
                // We only look at indices 1, 2, 3 (The deepest 20-60Hz bass)
                // We SKIP index 0 because it often contains "rumble" or DC offset noise
                let bassSum = dataArray[1] + dataArray[2] + dataArray[3];
                let bassAvg = bassSum / 3;

                // --- THE NOISE GATE (The Fix) ---
                const threshold = document.getElementById('threshold').value;
                
                // If the bass is quieter than the threshold, we pretend it is 0.
                if (bassAvg < threshold) {
                    energy = 0; 
                } else {
                    // If it passes the threshold, we use the value
                    energy = bassAvg;
                }

            } else {
                // "FULL AUDIO" MODE (Standard Average)
                let sum = 0;
                for(let i=0; i<bufferLength; i++) sum += dataArray[i];
                energy = sum / bufferLength;
            }

            // 2. APPLY SMOOTHING (LERP)
            const sensitivity = document.getElementById('intensity').value;
            
            // Math: Map energy (0-255) to a scale (1.0 - 1.X)
            // If energy is 0 (due to gate), target is 1.0 (no shake)
            targetScale = 1 + (energy / 255) * (sensitivity * 0.5);
            
            // Lerp formula: Move current value 20% closer to target value
            currentScale = currentScale + (targetScale - currentScale) * smoothingFactor;

            // 3. MOVE ELEMENTS
            logoContainer.style.transform = `translate(-50%, -50%) scale(${currentScale})`;
            bgLayer.style.transform = `scale(${1 + (currentScale-1)*0.3})`;


            // 4. DRAW SPECTRUM
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 150 * currentScale; 
            
            // Get user colors
            const colorStart = document.getElementById('color-start').value;
            const colorEnd = document.getElementById('color-end').value;

            ctx.beginPath();
            
            for (let i = 0; i < bufferLength; i++) {
                let barHeight = dataArray[i] * 0.7;
                
                // In Bass Mode, we artificially boost the visual bars just for looks
                // even if the shake is gated, we want the bars to move a little
                if (currentMode === 'bass') {
                     if (i < 5) barHeight *= 1.8; // Boost low bars
                     else barHeight *= 0.5;       // Suppress high bars
                }

                const rads = (i * 2 * Math.PI) / bufferLength;
                const x = centerX + Math.cos(rads) * (radius + barHeight);
                const y = centerY + Math.sin(rads) * (radius + barHeight);
                const x_inner = centerX + Math.cos(rads) * (radius + 5); 
                const y_inner = centerY + Math.sin(rads) * (radius + 5); 

                ctx.moveTo(x_inner, y_inner);
                ctx.lineTo(x, y);
            }

            // Apply Gradient
            const gradient = ctx.createLinearGradient(centerX, centerY - radius, centerX, centerY + radius);
            gradient.addColorStop(0, colorStart);
            gradient.addColorStop(1, colorEnd);
            
            ctx.strokeStyle = gradient;
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.shadowBlur = 10;
            ctx.shadowColor = colorStart;
            ctx.stroke();
            ctx.shadowBlur = 0;
        }

        // --- UTILS ---
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
        document.addEventListener('keydown', (e) => {
            if(e.key.toLowerCase() === 'h') {
                const ui = document.getElementById('ui-controls');
                ui.style.display = ui.style.display === 'none' ? 'block' : 'none';
            }
        });
    </script>
</body>
</html>
