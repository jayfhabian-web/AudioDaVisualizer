<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Phonk V35 - Render Edition</title>
    <style>
        /* --- THEME --- */
        :root {
            --bg: #000;
            --panel: rgba(10, 10, 10, 0.95);
            --border: rgba(255, 255, 255, 0.15);
            --text: #ccc;
            --accent: #ff0033;
            --btn-bg: #1a1a1a;
        }
        * { box-sizing: border-box; user-select: none; }
        body { margin: 0; background: var(--bg); font-family: 'Segoe UI', monospace; overflow: hidden; color: var(--text); }

        /* --- STAGE --- */
        #stage {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; z-index: 1; display: flex; justify-content: center; align-items: center;
        }
        
        /* LAYERS */
        #bg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #bg-img, #bg-video { width: 100%; height: 100%; object-fit: cover; opacity: 0.5; filter: grayscale(100%); }
        
        #particle-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; }
        #visualizer-layer { position: absolute; z-index: 10; pointer-events: none; }
        
        #logo-container {
            position: absolute; width: 320px; height: 320px; border-radius: 50%; 
            background-size: cover; background-position: center; z-index: 8;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            border: 2px solid rgba(255,255,255,0.05);
        }

        /* WATERMARK */
        #watermark-container {
            position: absolute; z-index: 20; pointer-events: none;
            display: flex; justify-content: center; align-items: center;
        }
        #wm-text { font-family: Impact, sans-serif; text-transform: uppercase; color: rgba(255,255,255,0.5); letter-spacing: 5px; white-space: nowrap; }
        #wm-img { object-fit: contain; opacity: 0.8; }

        /* OVERLAYS */
        #vfx-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 30; pointer-events: none; mix-blend-mode: overlay; }
        
        /* --- UI PANEL --- */
        #ui-panel {
            position: absolute; top: 0; left: 0; width: 440px; height: 100vh;
            background: var(--panel); border-right: 1px solid var(--border);
            padding: 15px; z-index: 50; overflow-y: auto;
            backdrop-filter: blur(15px); transition: transform 0.2s;
        }
        #ui-panel.hidden { transform: translateX(-100%); }

        /* Controls */
        h2 { font-size: 14px; color: #fff; margin: 0 0 15px 0; border-left: 3px solid var(--accent); padding-left: 10px; text-transform: uppercase; letter-spacing: 2px; }
        h3 { font-size: 10px; color: #666; margin-top: 20px; border-bottom: 1px solid #333; padding-bottom: 4px; font-weight: 700; text-transform: uppercase; }
        .control-group { margin-bottom: 12px; }
        label { display: flex; justify-content: space-between; font-size: 9px; color: #888; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; }
        select, input[type="text"], input[type="file"] { width: 100%; background: #0a0a0a; border: 1px solid #333; color: #ccc; padding: 6px; font-size: 10px; text-transform: uppercase; border-radius: 4px; outline: none; }
        
        button.action-btn { width: 100%; padding: 8px; background: var(--btn-bg); border: 1px solid #333; color: #ccc; cursor: pointer; font-size: 9px; font-weight: bold; transition: 0.2s; }
        button.action-btn:hover { background: #333; color: #fff; }
        
        /* Record Button */
        #rec-btn { background: #300; border-color: #500; color: #f88; }
        #rec-btn.recording { background: #f00; color: #fff; animation: pulse-rec 1s infinite; box-shadow: 0 0 15px #f00; }
        @keyframes pulse-rec { 0% { opacity:1; } 50% { opacity:0.7; } 100% { opacity:1; } }

        /* Sliders */
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 4px; background: #222; border-radius: 2px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: #fff; border-radius: 50%; cursor: pointer; border: 2px solid #000; }

        /* Architect Grid */
        .sculptor-grid { display: flex; gap: 4px; height: 240px; margin-bottom: 10px; }
        .sculpt-col { flex: 1; background: #080808; border: 1px solid #222; position: relative; display: flex; flex-direction: column; }
        .graph-area { flex: 1; position: relative; border-bottom: 1px solid #333; cursor: row-resize; overflow: hidden; background: rgba(255,255,255,0.02); }
        .audio-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: #555; opacity: 0.8; transition: height 0.05s linear; }
        .thresh-line { position: absolute; left: 0; width: 100%; height: 2px; background: #fff; box-shadow: 0 0 8px #fff; pointer-events: none; }
        
        .col-controls { height: 100px; padding: 5px; display: flex; flex-direction: column; justify-content: space-between; background: #050505; }
        .edit-btn { width: 100%; font-size: 8px; padding: 4px; background: #181818; border: 1px solid #333; color: #888; cursor: pointer; margin-bottom: 4px; }
        
        /* Vertical Sliders */
        .sliders-row { display: flex; justify-content: space-around; height: 65px; }
        .v-slider-group { display: flex; flex-direction: column; align-items: center; width: 45%; }
        .v-slider-label { font-size: 8px; color: #666; margin-bottom: 2px; font-weight: bold; }
        input[type=range].v-slider { 
            -webkit-appearance: none; width: 55px; height: 4px; 
            transform: rotate(-90deg) translate(-25px, 0); margin: 30px 0; background: #333; cursor: pointer; 
        }

        /* VFX Row */
        .vfx-row { display: flex; align-items: center; background: #0e0e0e; border: 1px solid #222; padding: 6px; margin-bottom: 6px; border-radius: 4px; gap: 6px; }
        .vfx-name { width: 60px; font-size: 9px; font-weight: bold; color: #bbb; }
        .vfx-slider { flex: 1; }
        .vfx-inv { font-size: 8px; padding: 2px 4px; cursor: pointer; background: #222; color: #666; border: 1px solid #333; border-radius: 3px; }
        .vfx-inv.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .vfx-select { width: 55px; font-size: 8px; height: 18px; padding: 0; background: #151515; border-color: #333; }

        /* Watermark Controls */
        .wm-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }

        /* Tweak Modal */
        #tweak-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 100; 
            display: none; align-items: center; justify-content: center; 
            backdrop-filter: blur(8px); 
        }
        #tweak-modal.active { display: flex; }
        .tweak-box { 
            width: 320px; background: #080808; border: 1px solid #333; 
            padding: 20px; border-radius: 6px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.9);
            border-top: 2px solid var(--accent);
        }

        #toggle-ui { position: absolute; top: 15px; left: 460px; z-index: 60; background: #000; color: #fff; border: 1px solid #333; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-size: 9px; font-weight: bold; }
        #ui-panel.hidden + #toggle-ui { left: 15px; }
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <div id="stage">
        <div id="bg-layer">
            <div id="bg-default" style="width:100%; height:100%; background: radial-gradient(circle, #222 0%, #000 100%);"></div>
            <img id="bg-img" src="" style="display:none;">
            <video id="bg-video" loop muted playsinline style="display:none;"></video>
        </div>

        <div id="watermark-container">
            <span id="wm-text" style="font-size: 40px; display:none;">YOUR TEXT</span>
            <img id="wm-img" src="" style="display:none; max-width: 200px;">
        </div>

        <canvas id="particle-layer"></canvas>
        <canvas id="visualizer-layer"></canvas>
        <div id="logo-container"></div>
        <div id="vfx-overlay"></div>
    </div>

    <button id="toggle-ui" onclick="toggleUI()">OPEN ENGINE</button>

    <div id="ui-panel">
        <h2>Phonk V35 <span style="font-size:9px; opacity:0.5">RENDERER</span></h2>

        <div class="control-group" style="background:#111; padding:10px; border:1px solid #222; border-radius:4px;">
            <label style="color:#fff; border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:10px;">Export Video</label>
            <button class="action-btn" id="rec-btn" onclick="toggleRecord()" disabled>● START RECORDING</button>
            <p style="font-size:8px; color:#666; margin-top:5px;">Plays track & records screen. Press STOP to save .webm file.</p>
        </div>

        <div class="control-group">
            <label>Files</label>
            <input type="file" id="file-audio" accept="audio/*">
            <button class="action-btn" id="play-btn" onclick="togglePlay()" disabled style="margin-top:5px;">PLAY PREVIEW</button>
        </div>
        <div class="control-group">
            <label>Assets</label>
            <input type="file" id="file-logo" accept="image/*" title="Center Logo" style="margin-bottom:2px;">
            <input type="file" id="file-bg" accept="image/*,video/*" title="Background">
        </div>

        <h3>Architect</h3>
        <div class="control-group">
            <label>Visual Smoothness</label>
            <input type="range" id="smooth-factor" min="0.1" max="0.9" step="0.05" value="0.5">
        </div>

        <div class="sculptor-grid">
            <script>
                for(let i=0; i<4; i++){
                    document.write(`
                    <div class="sculpt-col">
                        <div class="graph-area" id="g-${i}" onmousedown="startDrag(${i}, event)">
                            <div class="audio-bar" id="b-${i}"></div>
                            <div class="thresh-line" id="l-${i}" style="bottom:${[80,60,65,85][i]}%"></div>
                        </div>
                        <div class="col-controls">
                            <button class="edit-btn" onclick="openTweak(${i})">DSP</button>
                            <div class="sliders-row">
                                <div class="v-slider-group"><div class="v-slider-label">G</div><input type="range" class="v-slider" id="gain-${i}" min="0.1" max="3" step="0.1" value="1.0"></div>
                                <div class="v-slider-group"><div class="v-slider-label" style="color:var(--accent)">P</div><input type="range" class="v-slider" id="punch-${i}" min="1" max="5" step="0.1" value="1.0"></div>
                            </div>
                        </div>
                    </div>`);
                }
            </script>
        </div>
        <div class="control-group"><label>Pre-Amp</label><input type="range" id="pre-amp" min="0.5" max="3" step="0.1" value="1.0"></div>

        <h3>VFX Rack</h3>
        <div class="vfx-row">
            <div class="vfx-name" style="color:var(--accent)">Deep Fry</div>
            <input type="range" class="vfx-slider" id="vfx-fry-amt" min="0" max="1" step="0.1" value="0.0">
            <div class="vfx-inv" id="inv-fry" onclick="toggleInv('fry')">INV</div>
            <select class="vfx-select" id="link-fry"><option value="-1">Glob</option><option value="0">20Hz</option><option value="1">40Hz</option></select>
        </div>
        <div class="vfx-row">
            <div class="vfx-name">RGB Split</div>
            <input type="range" class="vfx-slider" id="vfx-rgb-amt" min="0" max="1" step="0.1" value="0.3">
            <div class="vfx-inv" id="inv-rgb" onclick="toggleInv('rgb')">INV</div>
            <select class="vfx-select" id="link-rgb"><option value="-1">Glob</option><option value="0">20Hz</option><option value="1">40Hz</option></select>
        </div>
        <div class="vfx-row">
            <div class="vfx-name">Particles</div>
            <input type="range" class="vfx-slider" id="vfx-part-amt" min="0" max="1" step="0.1" value="0.5">
            <div class="vfx-inv" id="inv-part" onclick="toggleInv('part')">INV</div>
            <select class="vfx-select" id="link-part"><option value="0">20Hz</option><option value="1">40Hz</option><option value="-1">Glob</option></select>
        </div>

        <h3>Watermark</h3>
        <div class="control-group">
            <div style="display:flex; gap:5px;">
                <input type="text" id="wm-text-input" placeholder="TEXT..." oninput="updateWM()">
                <input type="file" id="wm-file" accept="image/*" style="width:80px;" title="Img">
            </div>
        </div>
        <div class="wm-controls">
            <select id="wm-mode"><option value="static">Static</option><option value="pulse">Pulse</option><option value="bounce">Bounce</option><option value="both">Both</option></select>
            <input type="range" id="wm-opacity" min="0" max="1" step="0.1" value="0.8" oninput="updateWM()">
        </div>
        <div style="height:50px;"></div>
    </div>

    <div id="tweak-modal">
        <div class="tweak-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:5px;">
                <h2 style="margin:0; border:none; padding:0;">DSP Editor</h2>
                <button onclick="closeTweak()" style="background:none; border:none; color:#666; cursor:pointer;">✕</button>
            </div>
            <div class="control-group"><label>Attack</label><input type="range" id="inp-atk" min="0" max="0.9" step="0.05"></div>
            <div class="control-group"><label>Decay</label><input type="range" id="inp-dec" min="0.01" max="0.5" step="0.01"></div>
            <div class="control-group"><label>Gate</label><input type="range" id="inp-gate" min="0" max="0.4" step="0.01"></div>
        </div>
    </div>

    <script>
        const dom = {
            playBtn: document.getElementById('play-btn'),
            recBtn: document.getElementById('rec-btn'),
            canvas: document.getElementById('visualizer-layer'),
            ctx: document.getElementById('visualizer-layer').getContext('2d'),
            pCanvas: document.getElementById('particle-layer'),
            pCtx: document.getElementById('particle-layer').getContext('2d'),
            stage: document.getElementById('stage'),
            // UI
            bars: [0,1,2,3].map(i => document.getElementById(`b-${i}`)),
            lines: [0,1,2,3].map(i => document.getElementById(`l-${i}`)),
            gains: [0,1,2,3].map(i => document.getElementById(`gain-${i}`)),
            punches: [0,1,2,3].map(i => document.getElementById(`punch-${i}`)),
            inputs: {
                smooth: document.getElementById('smooth-factor'),
                preAmp: document.getElementById('pre-amp'),
                fryAmt: document.getElementById('vfx-fry-amt'), fryLink: document.getElementById('link-fry'),
                rgbAmt: document.getElementById('vfx-rgb-amt'), rgbLink: document.getElementById('link-rgb'),
                partAmt: document.getElementById('vfx-part-amt'), partLink: document.getElementById('link-part')
            },
            wm: {
                cont: document.getElementById('watermark-container'), text: document.getElementById('wm-text'),
                img: document.getElementById('wm-img'), input: document.getElementById('wm-text-input'),
                mode: document.getElementById('wm-mode'), op: document.getElementById('wm-opacity')
            },
            // Tweak
            tweakModal: document.getElementById('tweak-modal'),
            tweakInputs: { atk: document.getElementById('inp-atk'), dec: document.getElementById('inp-dec'), gate: document.getElementById('inp-gate') }
        };

        // --- High DPI Setup ---
        function resize() {
            const dpr = window.devicePixelRatio || 1;
            const w = window.innerWidth; const h = window.innerHeight;
            dom.canvas.width = w * dpr; dom.canvas.height = h * dpr;
            dom.canvas.style.width = w + "px"; dom.canvas.style.height = h + "px";
            dom.ctx.scale(dpr, dpr);

            dom.pCanvas.width = w * dpr; dom.pCanvas.height = h * dpr;
            dom.pCanvas.style.width = w + "px"; dom.pCanvas.style.height = h + "px";
            dom.pCtx.scale(dpr, dpr);
        }
        window.addEventListener('resize', resize);
        resize();

        const state = {
            isPlaying: false, isRecording: false,
            physics: 0,
            inverts: { fry: false, rgb: false, part: false },
            bands: [0,1,2,3].map((_,i) => ({ val:0, thresh:[0.8,0.6,0.65,0.85][i], atk:0, dec:0.15, gate:0.05 })),
            currentTweak: -1,
            particles: [],
            wm: { x: window.innerWidth/2, y: window.innerHeight/4, dx: 3, dy: 3 }
        };

        // --- AUDIO & RECORDING ---
        let audioCtx, source, analyser, buffer, dest, mediaRecorder, chunks = [];
        
        document.getElementById('file-audio').addEventListener('change', async e => {
            if(!e.target.files[0]) return;
            const ab = await e.target.files[0].arrayBuffer();
            audioCtx = new (window.AudioContext||window.webkitAudioContext)();
            buffer = await audioCtx.decodeAudioData(ab);
            
            // Analyze volume for Pre-Amp
            const raw = buffer.getChannelData(0); let s=0; 
            for(let i=0;i<raw.length;i+=5000)s+=Math.abs(raw[i]);
            dom.inputs.preAmp.value = (s/(raw.length/5000) < 0.1) ? 2.0 : 1.0;
            
            dom.playBtn.disabled=false; dom.recBtn.disabled=false;
            dom.playBtn.innerText="PLAY PREVIEW";
        });

        window.togglePlay = () => {
            if(!buffer) return;
            if(state.isPlaying) { stopAll(); }
            else { startAudio(false); }
        };

        window.toggleRecord = () => {
            if(!buffer) return;
            if(state.isRecording) {
                mediaRecorder.stop();
                stopAll();
                dom.recBtn.classList.remove('recording');
                dom.recBtn.innerText = "● START RECORDING";
                state.isRecording = false;
            } else {
                startAudio(true);
                dom.recBtn.classList.add('recording');
                dom.recBtn.innerText = "■ STOP & SAVE";
                state.isRecording = true;
            }
        };

        function startAudio(recording) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            source = audioCtx.createBufferSource(); source.buffer=buffer;
            analyser = audioCtx.createAnalyser(); analyser.fftSize=2048;
            analyser.smoothingTimeConstant = parseFloat(dom.inputs.smooth.value); // Hardware smoothing

            // Routing
            source.connect(analyser); 
            source.connect(audioCtx.destination); // Hear it

            if(recording) {
                // Combine Canvas Stream + Audio Stream
                dest = audioCtx.createMediaStreamDestination();
                source.connect(dest);
                const canvasStream = dom.stage.getElementsByTagName('canvas')[1].captureStream(60); // Visualizer layer
                // Note: Capturing DOM elements (divs) isn't directly possible with MediaRecorder easily without html2canvas which is slow.
                // For V35, we only capture the canvas layer + audio to keep it fast. To capture full DOM requires complex libs.
                // We will combine the canvas stream.
                
                const combinedStream = new MediaStream([
                    ...canvasStream.getVideoTracks(),
                    ...dest.stream.getAudioTracks()
                ]);
                
                mediaRecorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm; codecs=vp9' });
                chunks = [];
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = e => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href=url; a.download='phonk_export.webm'; a.click();
                };
                mediaRecorder.start();
            }

            source.start(0); state.isPlaying=true; 
            if(!recording) dom.playBtn.innerText="STOP PREVIEW";
            loop();
        }

        function stopAll() {
            if(source) source.stop();
            state.isPlaying=false;
            dom.playBtn.innerText="PLAY PREVIEW";
        }

        // --- MAIN LOOP ---
        function loop() {
            if(!state.isPlaying) return;
            requestAnimationFrame(loop);

            const data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(data);
            
            // Smoothing Update
            analyser.smoothingTimeConstant = parseFloat(dom.inputs.smooth.value);

            const pre = parseFloat(dom.inputs.preAmp.value);
            const raw = [data[1], data[3], data[5], data[8]];
            let globalTrig = 0;
            const triggers = [0,0,0,0];

            raw.forEach((r, i) => {
                const gain = parseFloat(dom.gains[i].value);
                const punch = parseFloat(dom.punches[i].value);
                let input = (r/255) * pre * gain;
                
                const dsp = state.bands[i];
                if(input < dsp.gate) input = 0;
                
                // Visual LERP (Smoothing)
                if(input > dsp.val) dsp.val += (input - dsp.val) * (1-dsp.atk);
                else dsp.val -= dsp.dec;
                if(dsp.val < 0) dsp.val = 0;

                let visualVal = dsp.val;
                if (dsp.val > dsp.thresh) {
                    let excess = dsp.val - dsp.thresh;
                    visualVal = dsp.thresh + (excess * punch);
                }
                
                // DOM Bar Update
                dom.bars[i].style.height = Math.min(visualVal * 100, 100) + "%";
                dom.bars[i].style.background = (dsp.val > dsp.thresh) ? 'var(--accent)' : '#555';

                if(dsp.val > dsp.thresh) {
                    triggers[i] = (dsp.val - dsp.thresh) * 2;
                    globalTrig += triggers[i];
                }
            });

            // Smooth Physics
            state.physics += (globalTrig - state.physics) * 0.1;
            
            drawVisuals(data, state.physics);
            updateWatermark(state.physics);
            applyVFX(triggers, state.physics);
        }

        // --- DRAW ---
        class Particle {
            constructor() {
                this.x = window.innerWidth/2; this.y = window.innerHeight/2;
                const a = Math.random()*Math.PI*2; const s = Math.random()*15+5;
                this.vx = Math.cos(a)*s; this.vy = Math.sin(a)*s;
                this.life = 1.0; this.size = Math.random()*5+2;
            }
            update() { this.x+=this.vx; this.y+=this.vy; this.life-=0.02; this.vx*=0.95; this.vy*=0.95; }
            draw(ctx) { ctx.fillStyle=`rgba(255,50,50,${this.life})`; ctx.beginPath(); ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fill(); }
        }

        function drawVisuals(data, phys) {
            const ctx = dom.ctx; 
            const w = dom.canvas.width / (window.devicePixelRatio||1);
            const h = dom.canvas.height / (window.devicePixelRatio||1);
            const cx = w/2; const cy = h/2;

            ctx.clearRect(0,0,w,h);
            
            const bars = 60; 
            const rad = 200 + (phys*40);
            
            if(phys > 0.2) { ctx.shadowBlur = 20; ctx.shadowColor = "#ff0033"; } else { ctx.shadowBlur = 0; }

            for(let i=0; i<bars; i++) {
                let val = (data[i*2]/255) * parseFloat(dom.inputs.preAmp.value);
                let hVal = val * 220;
                if(phys>0.1) hVal *= (1+phys);
                ctx.save(); ctx.translate(cx,cy); ctx.rotate((Math.PI*2/bars)*i);
                ctx.fillStyle = (phys>0.2) ? "#ff0033" : "#fff";
                ctx.fillRect(rad, -6, Math.max(hVal,5), 12);
                ctx.restore();
            }

            // Particles
            const pCtx = dom.pCtx; pCtx.clearRect(0,0,w,h);
            const pLink = parseInt(dom.inputs.inputs.partLink.value);
            let pForce = (pLink===-1) ? phys : (state.bands[pLink]?.val > state.bands[pLink]?.thresh ? 1 : 0);
            if(state.inverts.part) pForce = 1-pForce;

            if(pForce > 0.1 && Math.random()<parseFloat(dom.inputs.inputs.partAmt.value)) 
                for(let k=0;k<5;k++) state.particles.push(new Particle());
            
            for(let i=state.particles.length-1; i>=0; i--) {
                state.particles[i].update(); state.particles[i].draw(pCtx);
                if(state.particles[i].life<=0) state.particles.splice(i,1);
            }
        }

        // --- WATERMARK & VFX ---
        function updateWatermark(phys) {
            const wm = dom.wm.cont; const mode = dom.wm.mode.value;
            const rect = wm.getBoundingClientRect();
            
            if(mode === 'bounce' || mode === 'both') {
                state.wm.x += state.wm.dx; state.wm.y += state.wm.dy;
                if(state.wm.x <= 0 || state.wm.x + rect.width >= window.innerWidth) state.wm.dx *= -1;
                if(state.wm.y <= 0 || state.wm.y + rect.height >= window.innerHeight) state.wm.dy *= -1;
                wm.style.left = state.wm.x + 'px'; wm.style.top = state.wm.y + 'px';
                wm.style.transform = 'none';
            } else {
                wm.style.left = '50%'; wm.style.top = '20%'; wm.style.transform = 'translate(-50%, -50%)';
            }

            let scale = 1;
            if(mode === 'pulse' || mode === 'both') scale = 1 + (phys * 0.5);
            
            if(mode === 'bounce' || mode === 'both') wm.style.transform = `scale(${scale})`;
            else wm.style.transform = `translate(-50%, -50%) scale(${scale})`;
        }

        function applyVFX(trigs, phys) {
            const getVal = (idx, inv) => {
                let v = (parseInt(idx)===-1) ? phys : (trigs[idx]||0);
                return inv ? (1-v) : v;
            };

            // Fry
            const fAmt = parseFloat(dom.inputs.inputs.fryAmt.value);
            const fVal = getVal(dom.inputs.inputs.fryLink.value, state.inverts.fry);
            let f = "grayscale(100%) ";
            if(fAmt>0 && fVal>0.1) f += `contrast(${100+(fVal*fAmt*400)}%) saturate(${100+(fVal*fAmt*400)}%)`;
            dom.stage.style.filter = f;

            // RGB
            const rAmt = parseFloat(dom.inputs.inputs.rgbAmt.value);
            const rVal = getVal(dom.inputs.inputs.rgbLink.value, state.inverts.rgb);
            if(rAmt > 0) {
                const s = rVal * rAmt * 30;
                dom.stage.style.textShadow = `${s}px 0 red, -${s}px 0 blue`;
                dom.canvas.style.transform = `translate(${s}px, 0)`; 
            } else {
                dom.stage.style.textShadow = 'none'; dom.canvas.style.transform = 'none';
            }
        }

        // --- UTILS ---
        window.toggleInv = (k) => { state.inverts[k]=!state.inverts[k]; document.getElementById(`inv-${k}`).classList.toggle('active'); };
        window.updateWM = () => {
            const t = dom.inputs.wm.input.value;
            if(t) { dom.wm.text.innerText=t; dom.wm.text.style.display='block'; dom.wm.img.style.display='none'; }
            dom.wm.cont.style.opacity = dom.inputs.wm.op.value;
        };
        document.getElementById('wm-file').addEventListener('change', e=>{
            dom.wm.img.src=URL.createObjectURL(e.target.files[0]); dom.wm.img.style.display='block'; dom.wm.text.style.display='none';
        });

        // Tweak
        window.openTweak = (i) => {
            state.currentTweak = i; const b = state.bands[i];
            dom.tweakInputs.atk.value=b.atk; dom.tweakInputs.dec.value=b.dec; dom.tweakInputs.gate.value=b.gate;
            dom.tweakModal.classList.add('active');
        };
        window.closeTweak = () => dom.tweakModal.classList.remove('active');
        ['atk','dec','gate'].forEach(k=>dom.tweakInputs[k].addEventListener('input',e=>state.bands[state.currentTweak][k]=parseFloat(e.target.value)));

        // File/Drag
        document.getElementById('file-logo').addEventListener('change', e=>{ document.getElementById('logo-container').style.backgroundImage=`url(${URL.createObjectURL(e.target.files[0])})`; });
        document.getElementById('file-bg').addEventListener('change', e=>{
            const f=e.target.files[0]; const u=URL.createObjectURL(f);
            if(f.type.startsWith('video')) { dom.bgVid.src=u; dom.bgVid.style.display='block'; dom.bgVid.play(); dom.bgImg.style.display='none'; dom.bgDef.style.display='none'; }
            else { dom.bgImg.src=u; dom.bgImg.style.display='block'; dom.bgVid.style.display='none'; dom.bgDef.style.display='none'; }
        });
        window.startDrag = (id, e) => {
            const up = () => { document.removeEventListener('mousemove',mv); document.removeEventListener('mouseup',up); };
            const mv = (ev) => {
                const r = document.getElementById(`g-${id}`).getBoundingClientRect();
                let y = 1-((ev.clientY-r.top)/r.height);
                state.bands[id].thresh = Math.max(0,Math.min(1,y));
                document.getElementById(`l-${id}`).style.bottom = (state.bands[id].thresh*100)+'%';
            };
            document.addEventListener('mousemove',mv); document.addEventListener('mouseup',up); mv(e);
        };
        window.toggleUI = () => document.getElementById('ui-panel').classList.toggle('hidden');
    </script>
</body>
</html>
