<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Phonk Engine V8 - Production Ready</title>
    <style>
        /* --- MODERN UI VARIABLES --- */
        :root {
            --primary: #ff0055;
            --bg: #050505;
            --panel: rgba(20, 20, 20, 0.85);
            --border: rgba(255, 255, 255, 0.1);
            --text: #e0e0e0;
        }

        body { margin: 0; background: var(--bg); font-family: 'Inter', 'Segoe UI', sans-serif; overflow: hidden; color: var(--text); }
        
        /* --- VISUAL LAYERS --- */
        #flash-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; z-index: 10; opacity: 0; mix-blend-mode: overlay;
        }
        
        #canvas-layer { position: absolute; top: 0; left: 0; z-index: 1; }
        
        #logo-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; height: 300px; z-index: 5;
            border-radius: 50%; 
            background-size: cover; background-position: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* --- CONTROL PANEL --- */
        #ui-panel {
            position: absolute; top: 0; left: 0; width: 320px; height: 100vh;
            background: var(--panel); backdrop-filter: blur(15px);
            border-right: 1px solid var(--border);
            padding: 20px; box-sizing: border-box; z-index: 20; overflow-y: auto;
            transition: transform 0.3s ease;
        }

        #ui-panel.hidden { transform: translateX(-100%); }

        /* TYPOGRAPHY & ELEMENTS */
        h2 { font-size: 18px; margin: 0 0 20px 0; letter-spacing: -0.5px; color: white; display:flex; align-items:center; gap:10px; }
        .status-dot { width: 8px; height: 8px; background: red; border-radius: 50%; display: inline-block; box-shadow: 0 0 5px red; }
        .status-dot.active { background: #00ff00; box-shadow: 0 0 8px #00ff00; }

        h3 { font-size: 12px; text-transform: uppercase; color: var(--primary); margin-top: 25px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        
        .control-group { margin-bottom: 15px; }
        label { display: flex; justify-content: space-between; font-size: 11px; color: #888; margin-bottom: 6px; font-weight: 600; }
        
        input[type="range"] { 
            width: 100%; height: 4px; background: #333; border-radius: 2px; 
            appearance: none; cursor: pointer; 
        }
        input[type="range"]::-webkit-slider-thumb { 
            appearance: none; width: 12px; height: 12px; background: var(--primary); border-radius: 50%; 
        }
        
        input[type="file"] { 
            width: 100%; background: #111; border: 1px solid var(--border); 
            padding: 8px; border-radius: 4px; color: #aaa; font-size: 11px; 
        }

        /* BASS METER */
        .meter-container { height: 6px; background: #111; border-radius: 3px; position: relative; overflow: hidden; margin-top: 5px; }
        .meter-fill { height: 100%; background: linear-gradient(90deg, var(--primary), #ff8800); width: 0%; transition: width 0.05s; }
        .meter-thresh { position: absolute; top: 0; bottom: 0; width: 2px; background: white; z-index: 2; box-shadow: 0 0 4px white; }

        /* EFFECT STACK CARDS */
        .effect-card {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            padding: 12px; border-radius: 6px; margin-bottom: 8px; position: relative;
        }
        .effect-card h4 { margin: 0 0 8px 0; font-size: 11px; color: white; display: flex; justify-content: space-between; }
        .remove-btn { cursor: pointer; opacity: 0.5; } .remove-btn:hover { opacity: 1; color: red; }
        
        .add-btn {
            width: 100%; padding: 10px; background: transparent; border: 1px dashed #444; color: #888;
            border-radius: 6px; cursor: pointer; font-size: 11px; margin-top: 5px; transition: 0.2s;
        }
        .add-btn:hover { border-color: var(--primary); color: white; background: rgba(255,0,85,0.05); }

        /* TOGGLE BUTTON */
        #toggle-btn {
            position: absolute; top: 20px; left: 340px; z-index: 21;
            background: var(--panel); border: 1px solid var(--border); color: white;
            padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: left 0.3s ease;
        }
        #ui-panel.hidden + #toggle-btn { left: 20px; }

        /* HIDDEN AUDIO PLAYER */
        #audio-player { width: 100%; margin-top: 10px; height: 30px; opacity: 0.8; }
    </style>
</head>
<body>

    <div id="flash-layer"></div>
    <canvas id="canvas-layer"></canvas>
    <div id="logo-container"></div>

    <div id="ui-panel">
        <h2>
            <span id="status-dot" class="status-dot"></span>
            PHONK MAKER
        </h2>

        <div class="control-group">
            <label>Song File</label>
            <input type="file" id="file-upload" accept="audio/*">
            <audio id="audio-player" controls></audio>
        </div>
        <div class="control-group">
            <label>Center Logo</label>
            <input type="file" id="img-upload" accept="image/*">
        </div>

        <h3>Bass Engine</h3>
        <div class="control-group">
            <label>Bass Threshold <span id="lbl-thresh">150</span></label>
            <div class="meter-container">
                <div id="thresh-line" class="meter-thresh" style="left: 58%"></div>
                <div id="meter-fill" class="meter-fill"></div>
            </div>
            <input type="range" id="threshold" min="0" max="255" value="150" oninput="updateUI(this.value, 'lbl-thresh')">
            <p style="font-size:10px; color:#666; margin-top:4px;">Drag slider until Red Line is just inside the moving bar.</p>
        </div>
        
        <div class="control-group">
            <label>Decay (Heaviness) <span id="lbl-decay">0.85</span></label>
            <input type="range" id="decay" min="0.1" max="0.95" step="0.05" value="0.85" oninput="updateUI(this.value, 'lbl-decay')">
        </div>

        <h3>Spectrum Style</h3>
        <div class="control-group">
            <label>Bar Count (Resolution) <span id="lbl-fft">128</span></label>
            <input type="range" id="fft-range" min="5" max="9" step="1" value="7" oninput="updateFFT(this.value)">
        </div>
        <div class="control-group">
            <label>Bass Bar Pop (Points Jump)</label>
            <input type="range" id="bass-pop" min="1" max="3" step="0.1" value="1.5">
        </div>
        <div class="control-group">
            <label>Colors</label>
            <div style="display:flex; gap:5px">
                <input type="color" id="col-1" value="#ff0055" style="height:30px; padding:0;">
                <input type="color" id="col-2" value="#5500ff" style="height:30px; padding:0;">
            </div>
        </div>

        <h3>Effect Stack</h3>
        <div id="stack-container"></div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <button class="add-btn" onclick="addFx('zoom')">+ Zoom</button>
            <button class="add-btn" onclick="addFx('rotate')">+ Rotate</button>
            <button class="add-btn" onclick="addFx('exposure')">+ Flash</button>
            <button class="add-btn" onclick="addFx('shake')">+ Shake</button>
        </div>
    </div>

    <button id="toggle-btn" onclick="togglePanel()">Hide Controls</button>

    <script>
        // --- CONFIG ---
        const state = {
            effects: [
                { id: 1, type: 'zoom', intensity: 0.4 }, // Default effect
            ],
            smoothedBass: 0,
            fftSize: 256,
            isConnected: false
        };

        const dom = {
            audio: document.getElementById('audio-player'),
            canvas: document.getElementById('canvas-layer'),
            ctx: document.getElementById('canvas-layer').getContext('2d'),
            logo: document.getElementById('logo-container'),
            flash: document.getElementById('flash-layer'),
            meter: document.getElementById('meter-fill'),
            threshLine: document.getElementById('thresh-line'),
            statusDot: document.getElementById('status-dot')
        };

        dom.canvas.width = window.innerWidth;
        dom.canvas.height = window.innerHeight;

        let audioCtx, analyser, source;

        // --- AUDIO CORE (V7 Engine) ---
        dom.audio.addEventListener('play', () => {
            if (state.isConnected) { if(audioCtx.state === 'suspended') audioCtx.resume(); return; }
            
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                source = audioCtx.createMediaElementSource(dom.audio);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = state.fftSize;
                
                source.connect(analyser);
                analyser.connect(audioCtx.destination);
                
                state.isConnected = true;
                dom.statusDot.classList.add('active');
                render();
            } catch(e) { console.error(e); }
        });

        // --- RENDER LOOP ---
        function render() {
            requestAnimationFrame(render);
            
            const bufferLength = analyser.frequencyBinCount;
            const data = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(data);

            // 1. BASS CALC (Indices 1-4)
            let rawBass = (data[1] + data[2] + data[3] + data[4]) / 4;
            
            // 2. UI METER UPDATE
            dom.meter.style.width = (rawBass / 255 * 100) + "%";
            
            // 3. THRESHOLD & GATE
            const threshVal = parseInt(document.getElementById('threshold').value);
            let activeBass = 0;
            if (rawBass > threshVal) {
                // Normalize the overflow (How much did we beat the threshold?)
                activeBass = (rawBass - threshVal) / (255 - threshVal); 
            }

            // 4. PHYSICS (Decay)
            const decay = parseFloat(document.getElementById('decay').value);
            if (activeBass > state.smoothedBass) {
                state.smoothedBass = activeBass; // Hit hard
            } else {
                state.smoothedBass *= decay; // Fade out
            }

            // 5. APPLY EFFECTS
            applyEffects(state.smoothedBass);

            // 6. DRAW SPECTRUM
            drawSpectrum(data, bufferLength, state.smoothedBass);
        }

        function applyEffects(bass) {
            let s = 1, r = 0, x = 0, y = 0, exp = 0;

            state.effects.forEach(fx => {
                const val = fx.intensity * bass;
                if (fx.type === 'zoom') s += val;
                if (fx.type === 'rotate') r += val * 30;
                if (fx.type === 'exposure') exp += val;
                if (fx.type === 'shake') {
                    // Random jitter based on bass
                    x += (Math.random() - 0.5) * val * 40;
                    y += (Math.random() - 0.5) * val * 40;
                }
            });

            // DOM Updates
            dom.logo.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px)) scale(${Math.max(0, s)}) rotate(${r}deg)`;
            
            // Exposure Logic
            if(Math.abs(exp) > 0.01) {
                dom.flash.style.opacity = Math.min(1, Math.abs(exp));
                dom.flash.style.background = exp > 0 ? 'white' : 'black';
            } else {
                dom.flash.style.opacity = 0;
            }
        }

        function drawSpectrum(data, count, bass) {
            dom.ctx.clearRect(0, 0, dom.canvas.width, dom.canvas.height);
            
            const centerX = dom.canvas.width / 2;
            const centerY = dom.canvas.height / 2;
            const radius = 150 + (bass * 40); // Base radius + bass shake

            const col1 = document.getElementById('col-1').value;
            const col2 = document.getElementById('col-2').value;
            const popStrength = parseFloat(document.getElementById('bass-pop').value);

            dom.ctx.beginPath();
            
            for(let i=0; i<count; i++) {
                let val = data[i];
                let barH = val * 0.8;

                // "POINTS JUMP OUT" FEATURE
                // If this is a low frequency (bass), multiply height by popStrength
                if (i < 8) {
                    barH *= (1 + (bass * (popStrength - 1)));
                }

                const rads = (i * 2 * Math.PI) / count - (Math.PI / 2); // Start at top
                
                const x0 = centerX + Math.cos(rads) * (radius + 5);
                const y0 = centerY + Math.sin(rads) * (radius + 5);
                const x1 = centerX + Math.cos(rads) * (radius + 5 + barH);
                const y1 = centerY + Math.sin(rads) * (radius + 5 + barH);

                dom.ctx.moveTo(x0, y0);
                dom.ctx.lineTo(x1, y1);
            }

            // Styling
            const grad = dom.ctx.createLinearGradient(centerX, centerY - radius, centerX, centerY + radius);
            grad.addColorStop(0, col1);
            grad.addColorStop(1, col2);
            
            dom.ctx.strokeStyle = grad;
            dom.ctx.lineWidth = (600 / count); // Auto-thin bars if there are many
            dom.ctx.lineCap = 'round';
            
            // Glow
            dom.ctx.shadowBlur = 10;
            dom.ctx.shadowColor = col1;
            
            dom.ctx.stroke();
            dom.ctx.shadowBlur = 0;
        }

        // --- UI UTILS ---
        document.getElementById('file-upload').addEventListener('change', (e) => {
            dom.audio.src = URL.createObjectURL(e.target.files[0]);
            dom.audio.play();
        });

        document.getElementById('img-upload').addEventListener('change', (e) => {
            dom.logo.style.backgroundImage = `url(${URL.createObjectURL(e.target.files[0])})`;
        });

        function updateUI(val, id) { document.getElementById(id).innerText = val; }
        
        // Update Threshold Line visual
        document.getElementById('threshold').addEventListener('input', (e) => {
            const pct = (e.target.value / 255) * 100;
            dom.threshLine.style.left = pct + '%';
        });

        function updateFFT(val) {
            const size = Math.pow(2, val);
            state.fftSize = size;
            if(analyser) analyser.fftSize = size;
            document.getElementById('lbl-fft').innerText = size / 2;
        }

        function togglePanel() {
            const p = document.getElementById('ui-panel');
            p.classList.toggle('hidden');
            document.getElementById('toggle-btn').innerText = p.classList.contains('hidden') ? "Show Controls" : "Hide Controls";
        }

        // --- STACK MANAGER ---
        function renderStack() {
            const con = document.getElementById('stack-container');
            con.innerHTML = '';
            state.effects.forEach(fx => {
                const div = document.createElement('div');
                div.className = 'effect-card';
                div.innerHTML = `
                    <h4>${fx.type.toUpperCase()} <span class="remove-btn" onclick="remFx(${fx.id})">Ã—</span></h4>
                    <input type="range" min="-2" max="2" step="0.1" value="${fx.intensity}" 
                        oninput="updFx(${fx.id}, this.value)">
                    <div style="display:flex; justify-content:space-between; font-size:9px; color:#555; margin-top:2px;">
                        <span>Invert</span><span>Normal</span>
                    </div>
                `;
                con.appendChild(div);
            });
        }

        window.addFx = (t) => { state.effects.push({id: Date.now(), type: t, intensity: 0.5}); renderStack(); }
        window.remFx = (id) => { state.effects = state.effects.filter(e => e.id !== id); renderStack(); }
        window.updFx = (id, v) => { state.effects.find(e => e.id === id).intensity = parseFloat(v); }
        
        renderStack(); // Init
        
        // Window Resize
        window.addEventListener('resize', () => {
            dom.canvas.width = window.innerWidth;
            dom.canvas.height = window.innerHeight;
        });
    </script>
</body>
</html>
