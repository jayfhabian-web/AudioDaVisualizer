<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Phonk Engine V40 - Master Base</title>
    <style>
        /* --- CORE STYLES --- */
        :root { --bg: #050505; --panel: #111; --accent: #ff0033; --text: #ccc; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        * { user-select: none; box-sizing: border-box; }

        /* --- SECTION 1: TOP VISUALIZER --- */
        #viewport {
            flex: 1; position: relative; overflow: hidden;
            background: radial-gradient(circle, #1a1a1a 0%, #000 100%);
            display: flex; justify-content: center; align-items: center;
        }
        canvas.vis-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* ARCHITECT OVERLAY (Left Side) */
        #architect-panel {
            position: absolute; left: 10px; top: 10px; width: 250px;
            background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid #333; z-index: 10;
        }
        .arch-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; font-size: 10px; }
        .arch-col { flex: 1; display: flex; flex-direction: column; gap: 2px; }
        input[type="range"] { width: 100%; height: 4px; background: #333; -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 10px; height: 10px; background: #888; border-radius: 50%; cursor: pointer; }
        .bar-container { height: 60px; background: #000; position: relative; border: 1px solid #333; margin-bottom: 5px; }
        .bar-fill { position: absolute; bottom: 0; width: 100%; background: var(--accent); transition: height 0.05s; }
        
        /* SETTINGS OVERLAY (Right Side) */
        #settings-panel {
            position: absolute; right: 10px; top: 10px; width: 200px;
            background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid #333; z-index: 10; text-align: right;
        }

        /* --- SECTION 2: TIMELINE (Bottom) --- */
        #timeline-area { height: 240px; background: #0e0e0e; border-top: 1px solid #333; display: flex; flex-direction: column; z-index: 20; }
        
        #toolbar {
            height: 40px; background: #151515; display: flex; align-items: center; padding: 0 10px; gap: 10px;
            border-bottom: 1px solid #222;
        }
        .tool-btn {
            padding: 4px 8px; background: #222; border: 1px solid #444; color: #aaa; font-size: 10px; cursor: grab;
        }
        .tool-btn:active { cursor: grabbing; }

        #timeline-scroll { flex: 1; overflow-x: auto; overflow-y: hidden; position: relative; background: #080808; }
        #tl-canvas { display: block; height: 100%; cursor: crosshair; }

        /* POPUP EDITOR */
        #block-editor {
            position: absolute; display: none; width: 220px;
            background: #1a1a1a; border: 1px solid var(--accent); z-index: 100;
            padding: 10px; box-shadow: 0 0 20px #000;
        }
        .ed-row { margin-bottom: 8px; font-size: 10px; }
        select { background: #333; color: #fff; border: 1px solid #444; width: 100%; }

    </style>
</head>
<body>

    <div id="viewport">
        <canvas id="c-vis" class="vis-layer"></canvas>
        <canvas id="c-fx" class="vis-layer" style="mix-blend-mode: screen;"></canvas>

        <div id="architect-panel">
            <strong style="color:var(--accent); font-size:11px;">AUDIO ARCHITECT</strong>
            <div style="display:flex; gap:4px; margin-top:5px;">
                <script>
                    ['SUB','LOW','MID','HI'].forEach((b,i) => {
                        document.write(`
                        <div class="arch-col">
                            <div class="bar-container"><div class="bar-fill" id="bar-${i}"></div></div>
                            <label>G <input type="range" id="gain-${i}" min="0" max="3" step="0.1" value="1"></label>
                            <label>P <input type="range" id="punch-${i}" min="1" max="5" step="0.1" value="2"></label>
                        </div>`);
                    });
                </script>
            </div>
            <div class="arch-row" style="margin-top:10px;">
                <span>Pre-Amp:</span> <input type="range" id="pre-amp" min="0.5" max="3" step="0.1" value="1.0">
            </div>
        </div>

        <div id="settings-panel">
            <button id="btn-load" style="background:#333; color:#fff; border:1px solid #555; padding:5px; width:100%;">LOAD AUDIO</button>
            <input type="file" id="inp-file" style="display:none" accept="audio/*">
            <div class="arch-row" style="margin-top:10px; justify-content:flex-end;">
                <span>Size:</span> <input type="range" id="vis-scale" min="0.5" max="2" step="0.1" value="1.0" style="width:60px;">
            </div>
        </div>
    </div>

    <div id="timeline-area">
        <div id="toolbar">
            <button id="btn-play" class="tool-btn">▶ PLAY</button>
            <span style="width:1px; height:20px; background:#444;"></span>
            <span style="font-size:10px; color:#666;">DRAG TO TIMELINE:</span>
            <div class="tool-btn" draggable="true" ondragstart="drag(event, 'shake')">Shake</div>
            <div class="tool-btn" draggable="true" ondragstart="drag(event, 'flash')">Flash</div>
            <div class="tool-btn" draggable="true" ondragstart="drag(event, 'invert')">Invert</div>
            <div class="tool-btn" draggable="true" ondragstart="drag(event, 'glitch')">Glitch</div>
        </div>

        <div id="timeline-scroll" ondrop="drop(event)" ondragover="allowDrop(event)">
            <canvas id="tl-canvas"></canvas>
        </div>

        <div id="block-editor">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <strong style="color:var(--accent)">EDIT BLOCK</strong>
                <button onclick="deleteBlock()" style="background:none; border:none; color:#f55; cursor:pointer;">x</button>
            </div>
            <div class="ed-row">
                <label>Easing Function</label>
                <select id="ed-ease" onchange="updateBlockVal('ease', this.value)">
                    <option value="linear">Linear (None)</option>
                    <option value="inQuad">In Quad (Slow Start)</option>
                    <option value="outQuad">Out Quad (Slow End)</option>
                    <option value="inOutQuad">In/Out Quad (Smooth)</option>
                    <option value="bounce">Bounce</option>
                    <option value="custom">Custom Formula</option>
                </select>
            </div>
            <div class="ed-row" id="custom-math-row" style="display:none;">
                <label>Custom Math (use 't' as 0-1)</label>
                <input type="text" id="ed-custom" value="t*t" onchange="updateBlockVal('custom', this.value)" style="width:100%; background:#000; color:#0f0; border:1px solid #333;">
            </div>
            <div class="ed-row">
                <label>Strength %</label>
                <input type="range" id="ed-str" min="0" max="100" oninput="updateBlockVal('str', this.value)">
            </div>
        </div>
    </div>

    <script>
        // --- MODULE: STATE ---
        const state = {
            ctx: null, src: null, anal: null, buf: null,
            play: false, start: 0, pause: 0, dur: 0,
            zoom: 100, // px per sec
            blocks: [], // { id, type, start, dur, str, ease, custom }
            selBlock: null,
            dragType: null,
            vis: { scale: 1.0 },
            arch: [0,0,0,0] // Band values
        };

        // --- MODULE: EASING LIBRARY ---
        const Easing = {
            linear: (t) => t,
            inQuad: (t) => t * t,
            outQuad: (t) => t * (2 - t),
            inOutQuad: (t) => t < .5 ? 2 * t * t : -1 + (4 - 2 * t) * t,
            bounce: (t) => {
                if (t < (1/2.75)) return 7.5625*t*t;
                else if (t < (2/2.75)) return 7.5625*(t-=(1.5/2.75))*t + .75;
                else if (t < (2.5/2.75)) return 7.5625*(t-=(2.25/2.75))*t + .9375;
                else return 7.5625*(t-=(2.625/2.75))*t + .984375;
            },
            custom: (t, formula) => {
                try { return new Function('t', `return ${formula}`)(t); } catch(e) { return t; }
            }
        };

        // --- MODULE: INIT & IO ---
        const cvs = { vis: document.getElementById('c-vis'), fx: document.getElementById('c-fx'), tl: document.getElementById('tl-canvas') };
        const ctx = { vis: cvs.vis.getContext('2d'), fx: cvs.fx.getContext('2d'), tl: cvs.tl.getContext('2d') };

        function init() {
            resize(); window.onresize = resize;
            
            document.getElementById('btn-load').onclick = () => document.getElementById('inp-file').click();
            document.getElementById('inp-file').onchange = async (e) => {
                const ab = await e.target.files[0].arrayBuffer();
                state.ctx = new (window.AudioContext||window.webkitAudioContext)();
                state.buf = await state.ctx.decodeAudioData(ab);
                state.dur = state.buf.duration;
                cvs.tl.width = state.dur * state.zoom;
                renderTimeline();
            };

            document.getElementById('btn-play').onclick = togglePlay;
            document.getElementById('vis-scale').oninput = (e) => state.vis.scale = parseFloat(e.target.value);
            
            // Timeline Interaction
            cvs.tl.onmousedown = (e) => {
                if(!state.buf) return;
                const rect = cvs.tl.getBoundingClientRect();
                const t = (e.clientX - rect.left) / state.zoom;
                // Hit test
                const hit = state.blocks.find(b => t >= b.start && t <= b.start + b.dur);
                if(hit) openEditor(hit, e.clientX, e.clientY);
                else closeEditor();
            };

            loop();
        }

        function resize() {
            const vp = document.getElementById('viewport');
            cvs.vis.width = cvs.fx.width = vp.clientWidth;
            cvs.vis.height = cvs.fx.height = vp.clientHeight;
            if(state.buf) renderTimeline();
        }

        function togglePlay() {
            if(state.play) {
                state.src.stop(); state.play = false;
                state.pause = state.ctx.currentTime - state.start;
                document.getElementById('btn-play').innerText = "▶ PLAY";
            } else {
                state.src = state.ctx.createBufferSource();
                state.src.buffer = state.buf;
                state.anal = state.ctx.createAnalyser();
                state.anal.fftSize = 1024;
                state.src.connect(state.anal);
                state.src.connect(state.ctx.destination);
                state.start = state.ctx.currentTime - state.pause;
                state.src.start(0, state.pause);
                state.play = true;
                document.getElementById('btn-play').innerText = "⏸ STOP";
            }
        }

        // --- MODULE: DRAG & DROP ---
        window.drag = (e, type) => { state.dragType = type; };
        window.allowDrop = (e) => e.preventDefault();
        window.drop = (e) => {
            e.preventDefault();
            const rect = document.getElementById('timeline-scroll').getBoundingClientRect();
            // Calculate time based on scroll position + drop X
            const scroll = document.getElementById('timeline-scroll').scrollLeft;
            const x = (e.clientX - rect.left) + scroll;
            const t = x / state.zoom;
            
            const newBlock = {
                id: Date.now(), type: state.dragType,
                start: t, dur: 1.0, str: 100,
                ease: 'linear', custom: 't'
            };
            state.blocks.push(newBlock);
            renderTimeline();
            openEditor(newBlock, e.clientX, e.clientY);
        };

        // --- MODULE: EDITOR ---
        function openEditor(b, x, y) {
            state.selBlock = b;
            const ed = document.getElementById('block-editor');
            ed.style.display = 'block';
            ed.style.left = Math.min(window.innerWidth-230, x)+'px';
            ed.style.top = Math.min(window.innerHeight-200, y-100)+'px';
            
            document.getElementById('ed-ease').value = b.ease;
            document.getElementById('ed-str').value = b.str;
            document.getElementById('ed-custom').value = b.custom;
            document.getElementById('custom-math-row').style.display = (b.ease === 'custom') ? 'block' : 'none';
        }

        window.updateBlockVal = (key, val) => {
            if(state.selBlock) {
                state.selBlock[key] = val;
                if(key==='ease') document.getElementById('custom-math-row').style.display = (val==='custom')?'block':'none';
                renderTimeline();
            }
        };

        window.deleteBlock = () => {
            state.blocks = state.blocks.filter(b => b !== state.selBlock);
            closeEditor();
            renderTimeline();
        };
        
        function closeEditor() { document.getElementById('block-editor').style.display = 'none'; state.selBlock = null; }

        // --- MODULE: MAIN LOOP ---
        function loop() {
            requestAnimationFrame(loop);
            
            // 1. Audio Processing
            let freq = new Uint8Array(0);
            if(state.play) {
                freq = new Uint8Array(state.anal.frequencyBinCount);
                state.anal.getByteFrequencyData(freq);
                
                // Process Architect Bands (Simple Avg)
                const bands = [[0,10], [11,50], [51,200], [201,500]];
                const pre = parseFloat(document.getElementById('pre-amp').value);
                
                bands.forEach((rng, i) => {
                    let sum=0; for(let k=rng[0]; k<rng[1]; k++) sum+=freq[k];
                    let avg = (sum/(rng[1]-rng[0]))/255;
                    // Apply Gain
                    avg *= parseFloat(document.getElementById(`gain-${i}`).value) * pre;
                    // Apply Punch (Threshold)
                    if(avg > 0.6) avg *= parseFloat(document.getElementById(`punch-${i}`).value);
                    
                    state.arch[i] = avg; // Store for visuals
                    document.getElementById(`bar-${i}`).style.height = (avg*100)+'%';
                });
            }

            // 2. Timeline Logic & Easing
            const t = state.play ? (state.ctx.currentTime - state.start) : state.pause;
            const activeFx = { shake:0, flash:0, invert:0, glitch:0 };
            
            state.blocks.forEach(b => {
                if(t >= b.start && t < b.start + b.dur) {
                    // Normalize Time (0 to 1)
                    let nt = (t - b.start) / b.dur;
                    
                    // Apply Easing
                    let intensity = 0;
                    if(b.ease === 'custom') intensity = Easing.custom(nt, b.custom);
                    else intensity = Easing[b.ease](nt);
                    
                    // Apply Strength
                    intensity *= (b.str / 100);
                    
                    activeFx[b.type] += intensity;
                }
            });

            // 3. Render
            renderVisuals(freq, activeFx);
            if(state.buf) renderPlayhead(t);
        }

        // --- MODULE: VISUALS ---
        function renderVisuals(freq, fx) {
            const w = cvs.vis.width; const h = cvs.vis.height;
            const c = ctx.vis;
            
            // Base Shake
            const sx = (Math.random()-0.5) * fx.shake * 50;
            const sy = (Math.random()-0.5) * fx.shake * 50;
            
            c.clearRect(0,0,w,h);
            c.save();
            c.translate(w/2 + sx, h/2 + sy);
            c.scale(state.vis.scale, state.vis.scale);
            
            // Draw Circle
            if(freq.length) {
                const rad = 150; 
                c.beginPath();
                for(let i=0; i<100; i++) {
                    // Mix raw audio with "Architect" bands for movement
                    let val = (freq[i*4]/255); 
                    if(i<10) val *= (1+state.arch[0]); // Sub influence
                    
                    const ang = (i/100) * Math.PI * 2;
                    const len = val * 200 * (1+fx.invert); // Invert affects size
                    c.moveTo(Math.cos(ang)*rad, Math.sin(ang)*rad);
                    c.lineTo(Math.cos(ang)*(rad+len), Math.sin(ang)*(rad+len));
                }
                c.strokeStyle = fx.invert > 0.5 ? '#fff' : '#ff0033';
                c.lineWidth = 2 + fx.glitch*10;
                c.stroke();
            }
            c.restore();

            // FX Layer
            const fxc = ctx.fx;
            fxc.clearRect(0,0,w,h);
            if(fx.flash > 0) {
                fxc.fillStyle = `rgba(255,255,255,${fx.flash})`;
                fxc.fillRect(0,0,w,h);
            }
            
            // Invert CSS
            cvs.vis.style.filter = `invert(${fx.invert}) blur(${fx.glitch*5}px)`;
        }

        // --- MODULE: TIMELINE RENDER ---
        function renderTimeline() {
            const c = ctx.tl;
            const w = cvs.tl.width; const h = cvs.tl.height;
            c.fillStyle = '#111'; c.fillRect(0,0,w,h);
            
            // Bass Map (Red BG)
            const data = state.buf.getChannelData(0);
            const step = Math.ceil(data.length / w);
            c.fillStyle = '#400';
            for(let i=0; i<w; i+=2) {
                let sum=0; for(let k=0; k<step*4; k++) sum+=Math.abs(data[i*step+k]||0);
                if(sum/(step*4) > 0.2) c.fillRect(i, 0, 2, h);
            }

            // Waveform (Grey FG)
            c.fillStyle = '#555';
            for(let i=0; i<w; i++) {
                let max=0; for(let k=0; k<step; k++) { let v=Math.abs(data[i*step+k]); if(v>max)max=v; }
                c.fillRect(i, h/2 - max*50, 1, max*100);
            }

            // Blocks
            state.blocks.forEach(b => {
                const x = b.start * state.zoom;
                const bw = b.dur * state.zoom;
                
                // Color Logic
                c.fillStyle = (state.selBlock===b) ? '#fff' : 'rgba(255,50,50,0.5)';
                if(b.type === 'flash') c.fillStyle = (state.selBlock===b) ? '#fff' : 'rgba(200,200,200,0.5)';
                
                c.fillRect(x, 10, bw, h-20);
                c.fillStyle = '#000'; c.fillText(`${b.type} (${b.ease})`, x+2, 22);
                
                // Draw Tween Curve
                c.strokeStyle = '#fff'; c.beginPath();
                c.moveTo(x, h-15);
                for(let k=0; k<bw; k+=5) {
                    let nt = k/bw;
                    let val = (b.ease==='custom') ? Easing.custom(nt, b.custom) : Easing[b.ease](nt);
                    c.lineTo(x+k, (h-15) - (val*20));
                }
                c.stroke();
            });
        }

        function renderPlayhead(t) {
            // Only update playhead overlay (cheat to save perf)
            // Ideally we redraw whole TL, but for now we just redraw timeline
            // renderTimeline(); // Uncomment for perfect frames, but slow
            // Cheap hack: just draw line
            const x = t * state.zoom;
            ctx.tl.fillStyle = '#f00';
            ctx.tl.fillRect(x, 0, 2, cvs.tl.height);
        }

        init();
    </script>
</body>
</html>
