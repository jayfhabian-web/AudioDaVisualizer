<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Phonk V34 - Watermark Edition</title>
    <style>
        /* --- THEME --- */
        :root {
            --bg: #000;
            --panel: rgba(12, 12, 12, 0.95);
            --border: rgba(255, 255, 255, 0.15);
            --text: #ccc;
            --accent: #ff0033;
            --btn-bg: #1a1a1a;
            --btn-active: #ff0033;
        }
        * { box-sizing: border-box; user-select: none; }
        body { margin: 0; background: var(--bg); font-family: 'Segoe UI', monospace; overflow: hidden; color: var(--text); }

        /* --- STAGE (2D) --- */
        #stage {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; z-index: 1; display: flex; justify-content: center; align-items: center;
        }
        
        /* LAYERS */
        #bg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #bg-img, #bg-video { width: 100%; height: 100%; object-fit: cover; opacity: 0.5; filter: grayscale(100%); }
        
        #particle-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; }
        #visualizer-layer { position: absolute; z-index: 10; pointer-events: none; }
        
        #logo-container {
            position: absolute; width: 320px; height: 320px; border-radius: 50%; 
            background-size: cover; background-position: center; z-index: 8;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            border: 2px solid rgba(255,255,255,0.05);
        }

        /* WATERMARK */
        #watermark-container {
            position: absolute; z-index: 20; pointer-events: none;
            display: flex; justify-content: center; align-items: center;
        }
        #wm-text { font-family: Impact, sans-serif; text-transform: uppercase; color: rgba(255,255,255,0.5); letter-spacing: 5px; white-space: nowrap; }
        #wm-img { object-fit: contain; opacity: 0.8; }

        /* OVERLAYS */
        #vfx-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 30; pointer-events: none; mix-blend-mode: overlay; }
        #flash-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 31; pointer-events: none; opacity: 0; background: white; mix-blend-mode: difference; }

        /* --- UI PANEL --- */
        #ui-panel {
            position: absolute; top: 0; left: 0; width: 440px; height: 100vh;
            background: var(--panel); border-right: 1px solid var(--border);
            padding: 15px; z-index: 50; overflow-y: auto;
            backdrop-filter: blur(15px);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #ui-panel.hidden { transform: translateX(-100%); }

        /* General UI */
        h2 { font-size: 14px; color: #fff; margin: 0 0 15px 0; border-left: 3px solid var(--accent); padding-left: 10px; text-transform: uppercase; letter-spacing: 2px; }
        h3 { font-size: 10px; color: #666; margin-top: 20px; border-bottom: 1px solid #333; padding-bottom: 4px; font-weight: 700; text-transform: uppercase; }
        .control-group { margin-bottom: 12px; }
        label { display: flex; justify-content: space-between; font-size: 9px; color: #888; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; }
        select, input[type="text"], input[type="file"] { width: 100%; background: #0a0a0a; border: 1px solid #333; color: #ccc; padding: 6px; font-size: 10px; text-transform: uppercase; border-radius: 4px; outline: none; }
        
        /* Buttons */
        button.action-btn { width: 100%; padding: 8px; background: var(--btn-bg); border: 1px solid #333; color: #ccc; cursor: pointer; font-size: 9px; font-weight: bold; transition: 0.2s; }
        button.action-btn:hover { background: #333; color: #fff; }
        button.action-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Sliders */
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 4px; background: #222; border-radius: 2px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: #fff; border-radius: 50%; cursor: pointer; border: 2px solid #000; }

        /* --- ARCHITECT GRID (Gain & Punch) --- */
        .sculptor-grid { display: flex; gap: 4px; height: 240px; margin-bottom: 10px; }
        .sculpt-col { flex: 1; background: #080808; border: 1px solid #222; position: relative; display: flex; flex-direction: column; }
        .graph-area { flex: 1; position: relative; border-bottom: 1px solid #333; cursor: row-resize; overflow: hidden; background: rgba(255,255,255,0.02); }
        .audio-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: #555; opacity: 0.8; transition: height 0.05s; }
        .thresh-line { position: absolute; left: 0; width: 100%; height: 2px; background: #fff; box-shadow: 0 0 8px #fff; pointer-events: none; }
        
        .col-controls { height: 100px; padding: 5px; display: flex; flex-direction: column; justify-content: space-between; background: #050505; }
        .edit-btn { width: 100%; font-size: 8px; padding: 4px; background: #181818; border: 1px solid #333; color: #888; cursor: pointer; margin-bottom: 4px; }
        .edit-btn:hover { color: #fff; border-color: #555; }
        
        /* Vertical Sliders (Gain/Punch) */
        .sliders-row { display: flex; justify-content: space-around; height: 65px; }
        .v-slider-group { display: flex; flex-direction: column; align-items: center; width: 45%; }
        .v-slider-label { font-size: 8px; color: #666; margin-bottom: 2px; font-weight: bold; }
        input[type=range].v-slider { 
            -webkit-appearance: none; width: 55px; height: 4px; 
            transform: rotate(-90deg) translate(-25px, 0); margin: 30px 0; background: #333; cursor: pointer; 
        }
        
        /* --- VFX ROW --- */
        .vfx-row { display: flex; align-items: center; background: #0e0e0e; border: 1px solid #222; padding: 6px; margin-bottom: 6px; border-radius: 4px; gap: 6px; }
        .vfx-name { width: 60px; font-size: 9px; font-weight: bold; color: #bbb; }
        .vfx-slider { flex: 1; }
        
        /* Invert Toggle & Link */
        .vfx-inv { 
            font-size: 8px; padding: 2px 4px; cursor: pointer; background: #222; color: #666; border: 1px solid #333; border-radius: 3px; 
        }
        .vfx-inv.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .vfx-select { width: 55px; font-size: 8px; height: 18px; padding: 0; background: #151515; border-color: #333; }

        /* --- WATERMARK CONTROLS --- */
        .wm-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }

        /* --- TWEAK MODAL (Restored & Polished) --- */
        #tweak-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 100; 
            display: none; align-items: center; justify-content: center; 
            backdrop-filter: blur(8px); 
        }
        #tweak-modal.active { display: flex; animation: fadeIn 0.2s ease-out; }
        
        .tweak-box { 
            width: 320px; background: #080808; border: 1px solid #333; 
            padding: 20px; border-radius: 6px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.9);
            border-top: 2px solid var(--accent);
        }
        .tweak-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #222; padding-bottom: 10px; }
        .tweak-header h2 { margin: 0; border: none; padding: 0; font-size: 14px; color: #fff; }
        .close-btn { background: none; border: none; color: #666; font-size: 14px; cursor: pointer; }
        .close-btn:hover { color: #fff; }
        
        @keyframes fadeIn { from { opacity:0; transform: scale(0.95); } to { opacity:1; transform: scale(1); } }

        /* Toggle UI Button */
        #toggle-ui { position: absolute; top: 15px; left: 460px; z-index: 60; background: #000; color: #fff; border: 1px solid #333; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-size: 9px; font-weight: bold; }
        #ui-panel.hidden + #toggle-ui { left: 15px; }
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <div id="stage">
        <div id="bg-layer">
            <div id="bg-default" style="width:100%; height:100%; background: radial-gradient(circle, #222 0%, #000 100%);"></div>
            <img id="bg-img" src="" style="display:none;">
            <video id="bg-video" loop muted playsinline style="display:none;"></video>
        </div>

        <div id="watermark-container">
            <span id="wm-text" style="font-size: 40px; display:none;">YOUR TEXT</span>
            <img id="wm-img" src="" style="display:none; max-width: 200px;">
        </div>

        <canvas id="particle-layer"></canvas>
        <canvas id="visualizer-layer"></canvas>
        <div id="logo-container"></div>

        <div id="vfx-overlay"></div>
        <div id="flash-layer"></div>
    </div>

    <button id="toggle-ui" onclick="toggleUI()">OPEN ENGINE</button>

    <div id="ui-panel">
        <h2>Phonk V34 <span style="font-size:9px; opacity:0.5">WATERMARK</span></h2>

        <div class="control-group">
            <label>Audio</label>
            <input type="file" id="file-audio" accept="audio/*">
            <button class="action-btn" id="play-btn" onclick="togglePlay()" disabled style="margin-top:5px;">LOAD AUDIO FIRST</button>
        </div>
        <div class="control-group">
            <label>Visual Assets</label>
            <input type="file" id="file-logo" accept="image/*" title="Center Logo" style="margin-bottom:2px;">
            <input type="file" id="file-bg" accept="image/*,video/*" title="Background">
        </div>

        <h3>Frequency Architect</h3>
        <p style="font-size:9px; color:#666; margin-bottom:5px;">G = Gain (Vol) | P = Punch (Peak Stretch)</p>
        
        <div class="sculptor-grid">
            <script>
                // Generating HTML for 4 bands to keep code clean
                for(let i=0; i<4; i++){
                    document.write(`
                    <div class="sculpt-col">
                        <div class="graph-area" id="g-${i}" onmousedown="startDrag(${i}, event)">
                            <div class="audio-bar" id="b-${i}"></div>
                            <div class="thresh-line" id="l-${i}" style="bottom:${[80,60,65,85][i]}%"></div>
                        </div>
                        <div class="col-controls">
                            <button class="edit-btn" onclick="openTweak(${i})">EDIT DSP</button>
                            <div class="sliders-row">
                                <div class="v-slider-group"><div class="v-slider-label">G</div><input type="range" class="v-slider" id="gain-${i}" min="0.1" max="3" step="0.1" value="1.0"></div>
                                <div class="v-slider-group"><div class="v-slider-label" style="color:var(--accent)">P</div><input type="range" class="v-slider" id="punch-${i}" min="1" max="5" step="0.1" value="1.0"></div>
                            </div>
                        </div>
                    </div>
                    `);
                }
            </script>
        </div>
        <div class="control-group"><label>Pre-Amp</label><input type="range" id="pre-amp" min="0.5" max="3" step="0.1" value="1.0"></div>

        <h3>VFX Rack</h3>
        
        <div class="vfx-row">
            <div class="vfx-name" style="color:var(--accent)">Deep Fry</div>
            <input type="range" class="vfx-slider" id="vfx-fry-amt" min="0" max="1" step="0.1" value="0.0">
            <div class="vfx-inv" id="inv-fry" onclick="toggleInv('fry')">INV</div>
            <select class="vfx-select" id="link-fry"><option value="-1">Glob</option><option value="0">20Hz</option><option value="1">40Hz</option></select>
        </div>

        <div class="vfx-row">
            <div class="vfx-name">RGB Split</div>
            <input type="range" class="vfx-slider" id="vfx-rgb-amt" min="0" max="1" step="0.1" value="0.3">
            <div class="vfx-inv" id="inv-rgb" onclick="toggleInv('rgb')">INV</div>
            <select class="vfx-select" id="link-rgb"><option value="-1">Glob</option><option value="0">20Hz</option><option value="1">40Hz</option></select>
        </div>

        <div class="vfx-row">
            <div class="vfx-name">Particles</div>
            <input type="range" class="vfx-slider" id="vfx-part-amt" min="0" max="1" step="0.1" value="0.5">
            <div class="vfx-inv" id="inv-part" onclick="toggleInv('part')">INV</div>
            <select class="vfx-select" id="link-part"><option value="0">20Hz</option><option value="1">40Hz</option><option value="-1">Glob</option></select>
        </div>

        <h3>Watermark System</h3>
        <div class="control-group">
            <label>Type</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="wm-text-input" placeholder="ENTER TEXT..." oninput="updateWM()">
                <input type="file" id="wm-file" accept="image/*" style="width:80px;" title="Img">
            </div>
        </div>
        <div class="wm-controls">
            <div>
                <label>Mode</label>
                <select id="wm-mode">
                    <option value="static">Static</option>
                    <option value="pulse">Pulse (Beat)</option>
                    <option value="bounce">DVD Bounce</option>
                    <option value="both">Bounce + Pulse</option>
                </select>
            </div>
            <div>
                <label>Opacity</label>
                <input type="range" id="wm-opacity" min="0" max="1" step="0.1" value="0.8" oninput="updateWM()">
            </div>
        </div>

        <div style="height:50px;"></div>
    </div>

    <div id="tweak-modal">
        <div class="tweak-box">
            <div class="tweak-header">
                <h2>DSP EDITOR: <span id="tweak-title" style="color:var(--accent)"></span></h2>
                <button class="close-btn" onclick="closeTweak()">âœ•</button>
            </div>
            
            <div class="control-group">
                <label>Attack (Response Speed)</label>
                <input type="range" id="inp-atk" min="0" max="0.9" step="0.05">
            </div>
            <div class="control-group">
                <label>Decay (Fade Out Speed)</label>
                <input type="range" id="inp-dec" min="0.01" max="0.5" step="0.01">
            </div>
            <div class="control-group">
                <label>Noise Gate (Sensitivity)</label>
                <input type="range" id="inp-gate" min="0" max="0.4" step="0.01">
            </div>
            <button class="action-btn" onclick="closeTweak()" style="margin-top:15px; background:var(--accent); color:white; border:none;">DONE</button>
        </div>
    </div>

    <script>
        const dom = {
            playBtn: document.getElementById('play-btn'),
            canvas: document.getElementById('visualizer-layer'),
            ctx: document.getElementById('visualizer-layer').getContext('2d'),
            pCanvas: document.getElementById('particle-layer'),
            pCtx: document.getElementById('particle-layer').getContext('2d'),
            logo: document.getElementById('logo-container'),
            stage: document.getElementById('stage'),
            // Overlays
            flash: document.getElementById('flash-layer'),
            vfxOver: document.getElementById('vfx-overlay'),
            // Background
            bgImg: document.getElementById('bg-img'),
            bgVid: document.getElementById('bg-video'),
            bgDef: document.getElementById('bg-default'),
            // Watermark
            wmCont: document.getElementById('watermark-container'),
            wmText: document.getElementById('wm-text'),
            wmImg: document.getElementById('wm-img'),
            wmInput: document.getElementById('wm-text-input'),
            wmMode: document.getElementById('wm-mode'),
            wmOp: document.getElementById('wm-opacity'),
            // Controls
            bars: [0,1,2,3].map(i => document.getElementById(`b-${i}`)),
            lines: [0,1,2,3].map(i => document.getElementById(`l-${i}`)),
            gains: [0,1,2,3].map(i => document.getElementById(`gain-${i}`)),
            punches: [0,1,2,3].map(i => document.getElementById(`punch-${i}`)),
            inputs: {
                preAmp: document.getElementById('pre-amp'),
                fryAmt: document.getElementById('vfx-fry-amt'), fryLink: document.getElementById('link-fry'),
                rgbAmt: document.getElementById('vfx-rgb-amt'), rgbLink: document.getElementById('link-rgb'),
                partAmt: document.getElementById('vfx-part-amt'), partLink: document.getElementById('link-part')
            },
            // Tweak
            tweakModal: document.getElementById('tweak-modal'),
            tweakTitle: document.getElementById('tweak-title'),
            tweakInputs: { atk: document.getElementById('inp-atk'), dec: document.getElementById('inp-dec'), gate: document.getElementById('inp-gate') }
        };

        // Resize
        function resize() {
            dom.canvas.width = window.innerWidth; dom.canvas.height = window.innerHeight;
            dom.pCanvas.width = window.innerWidth; dom.pCanvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // State
        const state = {
            isPlaying: false,
            physics: 0,
            inverts: { fry: false, rgb: false, part: false },
            bands: [0,1,2,3].map((_,i) => ({ val:0, thresh:[0.8,0.6,0.65,0.85][i], atk:0, dec:0.15, gate:0.05 })),
            currentTweak: -1,
            particles: [],
            wm: { x: window.innerWidth/2, y: window.innerHeight/4, dx: 3, dy: 3 } // Watermark physics
        };

        // --- PARTICLE SYSTEM ---
        class Particle {
            constructor() {
                this.x = window.innerWidth/2; this.y = window.innerHeight/2;
                const a = Math.random()*Math.PI*2; const s = Math.random()*15+5;
                this.vx = Math.cos(a)*s; this.vy = Math.sin(a)*s;
                this.life = 1.0; this.size = Math.random()*5+2;
            }
            update() { this.x+=this.vx; this.y+=this.vy; this.life-=0.02; this.vx*=0.95; this.vy*=0.95; }
            draw(ctx) { ctx.fillStyle=`rgba(255,50,50,${this.life})`; ctx.beginPath(); ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fill(); }
        }

        // --- AUDIO ENGINE ---
        let audioCtx, source, analyser, buffer;
        document.getElementById('file-audio').addEventListener('change', async e => {
            if(!e.target.files[0]) return;
            const ab = await e.target.files[0].arrayBuffer();
            audioCtx = new (window.AudioContext||window.webkitAudioContext)();
            buffer = await audioCtx.decodeAudioData(ab);
            const raw = buffer.getChannelData(0); let s=0; for(let i=0;i<raw.length;i+=5000)s+=Math.abs(raw[i]);
            dom.inputs.preAmp.value = (s/(raw.length/5000) < 0.1) ? 2.0 : 1.0;
            dom.playBtn.disabled=false; dom.playBtn.innerText="PLAY TRACK";
        });

        window.togglePlay = () => {
            if(!buffer) return;
            if(state.isPlaying) { source.stop(); state.isPlaying=false; dom.playBtn.innerText="PLAY TRACK"; }
            else {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                source = audioCtx.createBufferSource(); source.buffer=buffer;
                analyser = audioCtx.createAnalyser(); analyser.fftSize=2048;
                source.connect(analyser); source.connect(audioCtx.destination);
                source.start(0); state.isPlaying=true; dom.playBtn.innerText="STOP TRACK"; loop();
            }
        };

        // --- MAIN LOOP ---
        function loop() {
            if(!state.isPlaying) return;
            requestAnimationFrame(loop);

            const data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(data);
            const pre = parseFloat(dom.inputs.preAmp.value);
            const raw = [data[1], data[3], data[5], data[8]];
            let globalTrig = 0;
            const triggers = [0,0,0,0];

            raw.forEach((r, i) => {
                const gain = parseFloat(dom.gains[i].value);
                const punch = parseFloat(dom.punches[i].value);
                let input = (r/255) * pre * gain;
                
                const dsp = state.bands[i];
                if(input < dsp.gate) input = 0;
                if(input > dsp.val) dsp.val += (input - dsp.val) * (1-dsp.atk);
                else dsp.val -= dsp.dec;
                if(dsp.val < 0) dsp.val = 0;

                // Punch Logic
                let visualVal = dsp.val;
                if (dsp.val > dsp.thresh) {
                    let excess = dsp.val - dsp.thresh;
                    visualVal = dsp.thresh + (excess * punch);
                }
                
                dom.bars[i].style.height = Math.min(visualVal * 100, 100) + "%";
                dom.bars[i].style.background = (dsp.val > dsp.thresh) ? 'var(--accent)' : '#555';

                if(dsp.val > dsp.thresh) {
                    let f = (dsp.val - dsp.thresh) * 2;
                    triggers[i] = f;
                    globalTrig += f;
                }
            });

            state.physics += (globalTrig - state.physics) * 0.2;
            
            drawVisuals(data, state.physics);
            updateWatermark(state.physics);
            applyVFX(triggers, state.physics);
        }

        // --- DRAWING ---
        function drawVisuals(data, phys) {
            const ctx = dom.ctx; 
            const cx = dom.canvas.width/2; 
            const cy = dom.canvas.height/2;
            ctx.clearRect(0,0,dom.canvas.width,dom.canvas.height);
            
            // Draw Bars Circle
            const bars = 60; const rad = 180 + (phys*30);
            const pre = parseFloat(dom.inputs.preAmp.value);
            
            // Bloom logic (simulated in canvas for performance)
            if(phys > 0.2) { ctx.shadowBlur = 20; ctx.shadowColor = "#ff0033"; } 
            else { ctx.shadowBlur = 0; }

            for(let i=0; i<bars; i++) {
                let val = (data[i*2]/255) * pre;
                let h = val * 200;
                if(phys>0.1) h *= (1+phys);
                ctx.save(); ctx.translate(cx,cy); ctx.rotate((Math.PI*2/bars)*i);
                ctx.fillStyle = (phys>0.2) ? "#ff0033" : "#fff";
                ctx.fillRect(rad, -8, Math.max(h,5), 16);
                ctx.restore();
            }

            // Particles
            const pCtx = dom.pCtx; pCtx.clearRect(0,0,dom.canvas.width,dom.canvas.height);
            const pLink = parseInt(dom.inputs.inputs.partLink.value);
            let pForce = getLinkValue(pLink, [0,0,0,0], phys, state.inverts.part); // Simplified trigger check
            
            if(pForce > 0.1 && Math.random()<parseFloat(dom.inputs.inputs.partAmt.value)) 
                for(let k=0;k<5;k++) state.particles.push(new Particle());
            
            for(let i=state.particles.length-1; i>=0; i--) {
                state.particles[i].update(); state.particles[i].draw(pCtx);
                if(state.particles[i].life<=0) state.particles.splice(i,1);
            }
        }

        // --- WATERMARK PHYSICS ---
        function updateWatermark(phys) {
            const wm = dom.wmCont;
            const mode = dom.wmMode.value;
            const rect = wm.getBoundingClientRect();
            
            // Base Position
            let tx = 0, ty = 0;
            let scale = 1;

            if(mode === 'bounce' || mode === 'both') {
                // DVD Logic
                state.wm.x += state.wm.dx;
                state.wm.y += state.wm.dy;

                // Boundary check
                if(state.wm.x <= 0 || state.wm.x + rect.width >= window.innerWidth) state.wm.dx *= -1;
                if(state.wm.y <= 0 || state.wm.y + rect.height >= window.innerHeight) state.wm.dy *= -1;

                wm.style.left = state.wm.x + 'px';
                wm.style.top = state.wm.y + 'px';
                wm.style.transform = 'none'; // Clear center align
            } else {
                // Static Center
                wm.style.left = '50%'; wm.style.top = '20%'; 
                wm.style.transform = 'translate(-50%, -50%)';
            }

            if(mode === 'pulse' || mode === 'both') {
                scale = 1 + (phys * 0.5); // Pulse on beat
            }

            // Apply Scale
            if(mode === 'bounce' || mode === 'both') {
                wm.style.transform = `scale(${scale})`;
            } else {
                wm.style.transform = `translate(-50%, -50%) scale(${scale})`;
            }
        }

        // --- VFX CONTROLLER ---
        function getLinkValue(indexStr, trigs, phys, invert) {
            let val = 0;
            const idx = parseInt(indexStr);
            if(idx === -1) val = phys;
            else val = trigs[idx] || 0;

            if(invert) return (1.0 - val); // Invert Logic
            return val;
        }

        function applyVFX(trigs, phys) {
            // Deep Fry
            const fAmt = parseFloat(dom.inputs.inputs.fryAmt.value);
            const fVal = getLinkValue(dom.inputs.inputs.fryLink.value, trigs, phys, state.inverts.fry);
            let filter = "grayscale(100%) "; // Base look
            if(fAmt>0 && fVal > 0.1) {
                const v = 100 + (fVal*fAmt*400);
                filter += `contrast(${v}%) saturate(${v}%)`;
            }
            dom.stage.style.filter = filter;

            // RGB Split
            const rAmt = parseFloat(dom.inputs.inputs.rgbAmt.value);
            const rVal = getLinkValue(dom.inputs.inputs.rgbLink.value, trigs, phys, state.inverts.rgb);
            if(rAmt > 0) {
                const s = rVal * rAmt * 30;
                dom.stage.style.textShadow = `${s}px 0 red, -${s}px 0 blue`; // Glitches text/wm
                dom.canvas.style.transform = `translate(${s}px, 0)`; // Shake visualizer
            } else {
                dom.canvas.style.transform = `none`;
                dom.stage.style.textShadow = 'none';
            }
        }

        // --- UI LOGIC ---
        window.toggleInv = (key) => {
            state.inverts[key] = !state.inverts[key];
            document.getElementById(`inv-${key}`).classList.toggle('active');
        };

        window.updateWM = () => {
            const txt = dom.wmInput.value;
            const op = dom.wmOp.value;
            if(txt) { 
                dom.wmText.innerText = txt; dom.wmText.style.display = 'block'; dom.wmImg.style.display='none'; 
            } else { dom.wmText.style.display='none'; }
            dom.wmCont.style.opacity = op;
        };
        
        document.getElementById('wm-file').addEventListener('change', e=>{
            const u = URL.createObjectURL(e.target.files[0]);
            dom.wmImg.src=u; dom.wmImg.style.display='block'; dom.wmText.style.display='none'; dom.wmInput.value="";
        });

        // Tweak Modal Logic
        window.openTweak = (i) => {
            state.currentTweak = i; dom.tweakTitle.innerText=`${i*20+20}Hz`;
            const b = state.bands[i];
            dom.tweakInputs.atk.value=b.atk; dom.tweakInputs.dec.value=b.dec; dom.tweakInputs.gate.value=b.gate;
            dom.tweakModal.classList.add('active');
        };
        window.closeTweak = () => dom.tweakModal.classList.remove('active');
        ['atk','dec','gate'].forEach(k=>dom.tweakInputs[k].addEventListener('input',e=>state.bands[state.currentTweak][k]=parseFloat(e.target.value)));

        // File Handlers
        document.getElementById('file-logo').addEventListener('change', e=>{ dom.logo.style.backgroundImage=`url(${URL.createObjectURL(e.target.files[0])})`; });
        document.getElementById('file-bg').addEventListener('change', e=>{
            const f=e.target.files[0]; const u=URL.createObjectURL(f);
            if(f.type.startsWith('video')) { dom.bgVid.src=u; dom.bgVid.style.display='block'; dom.bgVid.play(); dom.bgImg.style.display='none'; dom.bgDef.style.display='none'; }
            else { dom.bgImg.src=u; dom.bgImg.style.display='block'; dom.bgVid.style.display='none'; dom.bgDef.style.display='none'; }
        });
        
        // Drag Threshold
        window.startDrag = (id, e) => {
            const up = () => { document.removeEventListener('mousemove',mv); document.removeEventListener('mouseup',up); };
            const mv = (ev) => {
                const r = document.getElementById(`g-${id}`).getBoundingClientRect();
                let y = 1-((ev.clientY-r.top)/r.height);
                state.bands[id].thresh = Math.max(0,Math.min(1,y));
                document.getElementById(`l-${id}`).style.bottom = (state.bands[id].thresh*100)+'%';
            };
            document.addEventListener('mousemove',mv); document.addEventListener('mouseup',up); mv(e);
        };

        window.toggleUI = () => document.getElementById('ui-panel').classList.toggle('hidden');
    </script>
</body>
</html>
